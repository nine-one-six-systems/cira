---
phase: 06-batch-processing
plan: 05
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
  - 06-03
  - 06-04
files_modified:
  - .planning/phases/06-batch-processing/06-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "All Phase 6 requirements (BAT-01 to BAT-04, API-02, UI-08, UI-09, UI-10) have passing tests"
    - "Test coverage demonstrates requirement satisfaction"
    - "Verification document maps requirements to test evidence"
  artifacts:
    - path: ".planning/phases/06-batch-processing/06-VERIFICATION.md"
      provides: "Requirement verification matrix with test evidence"
      min_lines: 150
  key_links:
    - from: "Requirement"
      to: "Test file"
      via: "verification mapping"
      pattern: "BAT-|API-|UI-"
---

<objective>
Run all Phase 6 tests and create verification documentation mapping requirements to test evidence.

Purpose: Provide traceable evidence that all Phase 6 requirements are satisfied by the implementation.

Output: Verification document with requirement-to-test mapping and pass/fail status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-batch-processing/06-RESEARCH.md
@backend/tests/test_batch_integration.py
@backend/tests/test_batch_api_integration.py
@backend/tests/test_batch_edge_cases.py
@frontend/src/__tests__/BatchUploadUI.test.tsx
@frontend/src/__tests__/ConfigPanel.test.tsx
@frontend/src/__tests__/DeleteModal.test.tsx
@backend/tests/test_batch_api.py
@backend/tests/test_batch_queue_api.py
@backend/tests/test_batch_queue_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run all Phase 6 tests and collect results</name>
  <files>backend/tests/, frontend/src/__tests__/</files>
  <action>
Run all tests created in Plans 01-04 plus existing batch tests and collect results:

1. Run backend batch integration tests (Plan 01):
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py -v --tb=short 2>&1
```

2. Run backend batch API integration tests (Plan 02):
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_api_integration.py -v --tb=short 2>&1
```

3. Run backend batch edge case tests (Plan 03):
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_edge_cases.py -v --tb=short 2>&1
```

4. Run existing batch unit tests to ensure no regressions:
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_api.py backend/tests/test_batch_queue_api.py backend/tests/test_batch_queue_service.py -v --tb=short 2>&1
```

5. Run frontend batch UI tests (Plan 04):
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/BatchUploadUI.test.tsx src/__tests__/ConfigPanel.test.tsx src/__tests__/DeleteModal.test.tsx 2>&1
```

6. Run full test suite to check for regressions:
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/ -v --tb=line -q 2>&1 | tail -20
```

Capture pass/fail counts and any failures for documentation.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py backend/tests/test_batch_api_integration.py backend/tests/test_batch_edge_cases.py backend/tests/test_batch_api.py backend/tests/test_batch_queue_api.py backend/tests/test_batch_queue_service.py --tb=line -q 2>&1 | tail -10
```
  </verify>
  <done>Test results collected for all Phase 6 test suites.</done>
</task>

<task type="auto">
  <name>Task 2: Create verification document</name>
  <files>.planning/phases/06-batch-processing/06-VERIFICATION.md</files>
  <action>
Create verification document at `.planning/phases/06-batch-processing/06-VERIFICATION.md`:

```markdown
# Phase 6: Batch Processing - Verification Report

**Verified:** [DATE]
**Status:** [PASS/FAIL]

## Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Batch Integration (06-01) | X | X | 0 |
| Batch API Integration (06-02) | X | X | 0 |
| Batch Edge Cases (06-03) | X | X | 0 |
| Batch UI (06-04) | X | X | 0 |
| Unit Tests (BatchAPI) | 16 | 16 | 0 |
| Unit Tests (BatchQueueAPI) | 23 | 23 | 0 |
| Unit Tests (BatchQueueService) | 35 | 35 | 0 |
| **Total** | **X** | **X** | **0** |

## Requirement Verification Matrix

### Batch Processing Requirements

| Req ID | Requirement | Test File | Test Name | Status |
|--------|-------------|-----------|-----------|--------|
| BAT-01 | CSV file upload | test_batch_integration.py, test_batch_api.py | test_valid_csv_creates_all_companies, test_batch_upload_valid_csv | PASS |
| BAT-02 | Validate CSV, report errors per row | test_batch_integration.py, test_batch_api.py | test_mixed_csv_reports_per_row_errors, test_duplicate_urls_detected | PASS |
| BAT-03 | Download CSV template | test_batch_integration.py, test_batch_api.py | test_template_has_required_columns, test_download_template | PASS |
| BAT-04 | Queue batch companies | test_batch_integration.py, test_batch_queue_service.py | test_batch_start_schedules_companies, test_company_completion_updates_batch_counts | PASS |

### API Requirements

| Req ID | Requirement | Test File | Test Name | Status |
|--------|-------------|-----------|-----------|--------|
| API-02 | POST /companies/batch | test_batch_api_integration.py, test_batch_api.py | TestBatchUploadResponses, test_batch_upload_* | PASS |

### UI Requirements

| Req ID | Requirement | Test File | Test Name | Status |
|--------|-------------|-----------|-----------|--------|
| UI-08 | Configure analysis options | ConfigPanel.test.tsx | TestConfigurationDisplay, TestModePresets | PASS |
| UI-09 | Upload batch CSV, preview | BatchUploadUI.test.tsx | TestBatchUploadDisplay, TestFileUpload, TestBatchSubmission | PASS |
| UI-10 | Delete company | DeleteModal.test.tsx, test_batch_api_integration.py | TestDeleteModalDisplay, TestDeleteConfirmation, TestDeleteCompanyEndpoint | PASS |

## Test Evidence

### Batch Integration Tests (06-01)
[Output from test run]

### Batch API Integration Tests (06-02)
[Output from test run]

### Batch Edge Case Tests (06-03)
[Output from test run]

### Batch UI Tests (06-04)
[Output from test run]

### Unit Tests
[Output from test run]

## Implementation Coverage

### Batch Upload (batch.py)
- CSV parsing with csv.DictReader: IMPLEMENTED
- Per-row validation with error collection: IMPLEMENTED
- Duplicate URL detection (within batch and database): IMPLEMENTED
- Atomic transaction for valid companies: IMPLEMENTED
- Template download with example data: IMPLEMENTED
- Response schema with success/fail counts: IMPLEMENTED

### BatchQueueService (batch_queue_service.py)
- Fair round-robin scheduling: IMPLEMENTED
- Priority-based batch ordering: IMPLEMENTED
- Global concurrency limits: IMPLEMENTED
- Progress tracking per batch: IMPLEMENTED
- on_company_status_change callback: IMPLEMENTED
- Auto-completion when all companies done: IMPLEMENTED

### Batch Control API (batch_queue.py)
- POST /batches/{id}/start endpoint: IMPLEMENTED
- POST /batches/{id}/pause endpoint: IMPLEMENTED
- POST /batches/{id}/resume endpoint: IMPLEMENTED
- POST /batches/{id}/cancel endpoint: IMPLEMENTED
- GET /batches/{id}/progress endpoint: IMPLEMENTED
- State transition validation: IMPLEMENTED

### Delete Company API (companies.py)
- DELETE /companies/{id} endpoint: IMPLEMENTED
- Cascade delete for pages, entities, analysis: IMPLEMENTED
- Cascade delete for token usage, checkpoint: IMPLEMENTED
- Batch count update on delete: IMPLEMENTED

### BatchUpload UI (BatchUpload.tsx)
- File drop zone: IMPLEMENTED
- CSV preview table: IMPLEMENTED
- Validation error highlighting: IMPLEMENTED
- Valid/invalid row counts: IMPLEMENTED
- Template download button: IMPLEMENTED
- Submit button state management: IMPLEMENTED

### Configuration UI (Settings.tsx)
- Quick/Thorough mode presets: IMPLEMENTED
- Max pages configuration: IMPLEMENTED
- Max depth configuration: IMPLEMENTED
- Settings persistence: IMPLEMENTED

### Delete Confirmation Modal
- Confirmation dialog: IMPLEMENTED
- Company name display: IMPLEMENTED
- Loading state during delete: IMPLEMENTED
- Success/error feedback: IMPLEMENTED

## Gaps Identified

[List any failing tests or uncovered requirements]

## Pre-existing Test Coverage

Phase 6 had extensive pre-existing test coverage:
- test_batch_api.py: 16 tests covering CSV parsing and validation
- test_batch_queue_api.py: 23 tests covering batch control endpoints
- test_batch_queue_service.py: 35 tests covering queue management

Plans 01-04 added integration tests to verify component wiring and edge cases.

## Recommendations

[Any recommendations based on verification results]
```

Fill in actual test results from Task 1.
  </action>
  <verify>
```bash
test -f /Users/stephenhollifield/Cira/.planning/phases/06-batch-processing/06-VERIFICATION.md && echo "Verification document exists" || echo "Missing"
```
  </verify>
  <done>Verification document created with complete requirement-to-test mapping.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 6 test suite and verification documentation covering all requirements:
- BAT-01 to BAT-04 (Batch Processing)
- API-02 (Batch Upload API)
- UI-08 (Configuration options)
- UI-09 (Batch CSV upload and preview)
- UI-10 (Delete company confirmation)
  </what-built>
  <how-to-verify>
1. Review `.planning/phases/06-batch-processing/06-VERIFICATION.md`
2. Check that all 8 requirements have associated tests
3. Check that all tests are passing (Status = PASS)
4. Optionally run backend tests:
   ```bash
   cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py backend/tests/test_batch_api_integration.py backend/tests/test_batch_edge_cases.py -v --tb=short | tail -50
   ```
5. Optionally run frontend tests:
   ```bash
   cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/BatchUploadUI.test.tsx src/__tests__/ConfigPanel.test.tsx src/__tests__/DeleteModal.test.tsx
   ```
6. Optionally test batch upload manually:
   - Navigate to Batch Upload page
   - Download template CSV
   - Upload a test CSV with multiple companies
   - Verify preview shows validation
   - Submit batch and verify companies created
7. Optionally test delete:
   - Navigate to Dashboard
   - Click delete on a company
   - Verify confirmation modal appears
   - Confirm deletion and verify company removed
  </how-to-verify>
  <resume-signal>Type "verified" to confirm Phase 6 is complete, or describe any gaps found.</resume-signal>
</task>

</tasks>

<verification>
Phase 6 is verified when:
1. All test suites pass
2. Verification document maps all requirements to tests
3. Human has confirmed the verification report

```bash
# Quick verification
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py backend/tests/test_batch_api_integration.py backend/tests/test_batch_edge_cases.py backend/tests/test_batch_api.py backend/tests/test_batch_queue_api.py backend/tests/test_batch_queue_service.py -v --tb=line 2>&1 | tail -20
```
</verification>

<success_criteria>
- [ ] All Phase 6 tests pass (new integration + existing unit tests)
- [ ] Verification document created
- [ ] All 8 requirements (BAT-01-04, API-02, UI-08-10) mapped to tests
- [ ] Human verification checkpoint approved
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-processing/06-05-SUMMARY.md`
</output>
