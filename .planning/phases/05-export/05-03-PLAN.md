---
phase: 05-export
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_export_edge_cases.py
autonomous: true

must_haves:
  truths:
    - "Export handles missing analysis data gracefully with placeholder text"
    - "Export handles empty analysis sections without crashing"
    - "Export handles special characters in company names"
    - "Export handles Unicode content in analysis text"
    - "Export handles very large analysis content without timeout"
    - "Export handles companies with no entities"
    - "Export handles companies with no pages"
    - "All edge cases produce valid export files"
  artifacts:
    - path: "backend/tests/test_export_edge_cases.py"
      provides: "Edge case and robustness tests for export functionality"
      min_lines: 200
  key_links:
    - from: "ExportService"
      to: "placeholder text"
      via: "graceful fallback"
      pattern: "No .* available"
    - from: "generate_export()"
      to: "filename sanitization"
      via: "safe_name replacement"
      pattern: "replace.*/"
---

<objective>
Create edge case and robustness tests for the export functionality covering boundary conditions, missing data, and unusual inputs.

Purpose: Ensure export functionality handles edge cases gracefully without crashing or producing invalid output, matching the robustness testing pattern established in prior phases.

Output: Edge case test file with class-based organization covering all export failure modes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-export/05-RESEARCH.md
@backend/app/services/export_service.py
@backend/tests/test_export_service.py
@backend/tests/test_state_edge_cases.py
@backend/tests/test_extraction_edge_cases.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export edge case tests for missing data</name>
  <files>backend/tests/test_export_edge_cases.py</files>
  <action>
Create edge case tests for export functionality in `backend/tests/test_export_edge_cases.py`:

1. **Test class: TestExportMissingAnalysis (EXP-05)**

   - `test_markdown_with_no_analysis`:
     - Create company with status=COMPLETED but NO analysis record
     - Generate markdown export
     - Assert contains company name in title
     - Assert contains "No executive summary available." or similar placeholder
     - Assert no exception raised

   - `test_word_with_no_analysis`:
     - Create company with no analysis
     - Generate Word export
     - Assert document opens without error
     - Assert contains placeholder text for sections

   - `test_pdf_with_no_analysis`:
     - Create company with no analysis
     - Generate PDF export
     - Assert PDF is valid (readable by PyPDF2)
     - Assert page count > 0

   - `test_json_with_no_analysis`:
     - Create company with no analysis
     - Generate JSON export
     - Assert valid JSON
     - Assert analysis object has null/empty values (not missing key)

2. **Test class: TestExportEmptySections (EXP-05)**

   - `test_markdown_with_empty_full_analysis`:
     - Create company with Analysis but full_analysis={}
     - Generate markdown
     - Assert all section headings still present
     - Assert placeholder text for each section

   - `test_markdown_with_partial_sections`:
     - Create company with only companyOverview section
     - Generate markdown
     - Assert companyOverview content appears
     - Assert other sections have placeholder text

   - `test_json_with_empty_sections`:
     - Create company with full_analysis={}
     - Generate JSON
     - Assert sections object present but empty

   - `test_word_with_null_content_fields`:
     - Create company with analysis where section content is None
     - Generate Word export
     - Assert no crash
     - Assert document opens

3. **Test class: TestExportSpecialCharacters (EXP-05)**

   - `test_filename_sanitizes_slashes`:
     - Create company named "Acme/Corp Inc"
     - Generate export
     - Assert filename has no "/" character
     - Assert underscore or dash substitution

   - `test_filename_sanitizes_backslashes`:
     - Create company named "Test\\Company"
     - Generate export
     - Assert filename has no "\\" character

   - `test_filename_sanitizes_ampersand`:
     - Create company named "Foo & Bar LLC"
     - Generate export
     - Assert filename is reasonable (& may be kept or converted)

   - `test_filename_handles_long_names`:
     - Create company with 100-character name
     - Generate export
     - Assert filename is truncated to reasonable length (<=50 chars)

   - `test_markdown_handles_special_chars_in_content`:
     - Create analysis with markdown special chars: | * # ` < > in content
     - Generate markdown
     - Assert output is valid markdown (no rendering errors)

4. Use class-based organization matching test_extraction_edge_cases.py pattern.

5. Each test should have docstring linking to EXP-05 (template structure) requirement.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_edge_cases.py::TestExportMissingAnalysis backend/tests/test_export_edge_cases.py::TestExportEmptySections backend/tests/test_export_edge_cases.py::TestExportSpecialCharacters -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>Edge case tests for missing data and special characters pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create export edge case tests for unusual content</name>
  <files>backend/tests/test_export_edge_cases.py</files>
  <action>
Add additional edge case tests to the existing file:

1. **Test class: TestExportUnicodeContent (EXP-05)**

   - `test_markdown_handles_unicode_company_name`:
     - Create company named "Acme Corp"
     - Generate markdown
     - Assert UTF-8 encoding preserves characters

   - `test_markdown_handles_unicode_analysis_content`:
     - Create analysis with Unicode in content (emojis, CJK, accents)
     - Generate markdown
     - Assert content preserved correctly

   - `test_word_handles_unicode`:
     - Create company with Unicode name and content
     - Generate Word export
     - Assert document opens
     - Assert text content preserved

   - `test_json_handles_unicode`:
     - Create company with Unicode content
     - Generate JSON
     - Assert valid JSON
     - Assert Unicode strings preserved (not escaped to \\uXXXX)

2. **Test class: TestExportLargeContent (EXP-05)**

   - `test_markdown_handles_large_analysis`:
     - Create analysis with 10KB content per section (70KB+ total)
     - Generate markdown
     - Assert completes without timeout (< 5 seconds)
     - Assert output contains all content

   - `test_pdf_handles_large_analysis`:
     - Create analysis with large content
     - Generate PDF
     - Assert completes without error
     - Assert page count reasonable (not exceeding 20 pages)

   - `test_json_handles_many_entities`:
     - Create company with 500 entities
     - Generate JSON with include_raw_data=True
     - Assert completes within timeout
     - Assert entities array length is 500

   - `test_json_handles_many_pages`:
     - Create company with 100 pages
     - Generate JSON with include_raw_data=True
     - Assert pages array length is 100

3. **Test class: TestExportMissingRelatedData (EXP-05)**

   - `test_export_with_no_entities`:
     - Create company with analysis but no Entity records
     - Generate markdown, Word, PDF, JSON
     - Assert all succeed without error
     - Assert JSON entities array is empty []

   - `test_export_with_no_pages`:
     - Create company with analysis but no Page records
     - Generate all formats
     - Assert all succeed
     - Assert JSON pages array is empty []

   - `test_export_with_no_token_usage`:
     - Create company with analysis but no TokenUsage records
     - Generate markdown
     - Assert token count shows 0 or N/A
     - Assert no division by zero errors

   - `test_json_without_raw_data_excludes_empty_arrays`:
     - Create company with no entities/pages
     - Generate JSON with include_raw_data=False
     - Assert "entities" key not present (not empty array)
     - Assert "pages" key not present

4. **Test class: TestExportContentValidation (EXP-05)**

   - `test_markdown_output_is_valid_utf8`:
     - Generate markdown for any company
     - Attempt to encode as UTF-8
     - Assert no encoding errors

   - `test_word_output_is_valid_docx`:
     - Generate Word export
     - Assert starts with PK magic bytes (ZIP format)
     - Assert python-docx can parse it

   - `test_pdf_output_is_valid_pdf`:
     - Generate PDF export
     - Assert starts with %PDF magic bytes
     - Assert PyPDF2 can parse it

   - `test_json_output_is_valid_json`:
     - Generate JSON export
     - Assert json.loads succeeds
     - Assert result is dict with expected keys

5. Each test should have docstring with requirement traceability.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_edge_cases.py -v --tb=short 2>&1 | tail -40
```
  </verify>
  <done>All export edge case tests pass, verifying robustness of export functionality.</done>
</task>

</tasks>

<verification>
Run all export edge case tests:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_edge_cases.py -v
```

Expected: All tests pass, demonstrating export handles all edge cases gracefully.
</verification>

<success_criteria>
- [ ] Tests cover missing analysis data scenarios
- [ ] Tests cover empty section scenarios
- [ ] Tests cover special characters in filenames
- [ ] Tests cover Unicode content in all formats
- [ ] Tests cover large content performance
- [ ] Tests cover missing related data (entities, pages, tokens)
- [ ] Tests verify output validity for all formats
- [ ] All tests pass with existing implementation
- [ ] Tests organized in classes matching project pattern
- [ ] Tests documented with EXP-05 requirement traceability
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-03-SUMMARY.md`
</output>
