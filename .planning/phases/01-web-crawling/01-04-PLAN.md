---
phase: 01-web-crawling
plan: 04
type: execute
wave: 2
depends_on:
  - 01-02
files_modified:
  - frontend/src/__tests__/AddCompany.test.tsx
  - frontend/src/__tests__/Dashboard.test.tsx
autonomous: true

must_haves:
  truths:
    - "AddCompany form validates required fields before submission"
    - "AddCompany form auto-normalizes URL (adds https://)"
    - "Dashboard displays company list with status badges"
    - "Dashboard supports filtering by status and search by name"
  artifacts:
    - path: "frontend/src/__tests__/AddCompany.test.tsx"
      provides: "Component tests for company submission form"
      min_lines: 80
    - path: "frontend/src/__tests__/Dashboard.test.tsx"
      provides: "Component tests for company list view"
      min_lines: 100
  key_links:
    - from: "AddCompany"
      to: "useCreateCompany"
      via: "form submission"
      pattern: "createMutation\\.mutateAsync"
    - from: "Dashboard"
      to: "useCompanies"
      via: "data fetching"
      pattern: "useCompanies"
---

<objective>
Create frontend component tests that verify UI-01 and UI-02 requirements for company submission and listing.

Purpose: Validate that the React components correctly handle user interactions, form validation, and data display.

Output: Component test files using React Testing Library.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-web-crawling/01-RESEARCH.md
@frontend/src/pages/AddCompany.tsx
@frontend/src/pages/Dashboard.tsx
@frontend/src/hooks/useCompanies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddCompany component tests</name>
  <files>frontend/src/__tests__/AddCompany.test.tsx</files>
  <action>
Create component tests for AddCompany in `frontend/src/__tests__/AddCompany.test.tsx`:

First, check if testing setup exists. If not, the test file should include necessary imports.

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { BrowserRouter } from 'react-router-dom';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import AddCompany from '../pages/AddCompany';

// Mock the hooks
vi.mock('../hooks/useCompanies', () => ({
  useCreateCompany: vi.fn(() => ({
    mutateAsync: vi.fn(),
    isPending: false,
  })),
}));

vi.mock('../components/ui', async () => {
  const actual = await vi.importActual('../components/ui');
  return {
    ...actual,
    useToast: () => ({ showToast: vi.fn() }),
  };
});
```

1. **Test suite: AddCompany Form Validation**
   - `renders all required form fields`:
     - Assert company name input exists
     - Assert website URL input exists
     - Assert submit button exists

   - `shows error when submitting empty form`:
     - Click submit without filling fields
     - Assert error message appears for company name
     - Assert error message appears for URL

   - `validates URL format`:
     - Enter 'not-a-url' in URL field
     - Submit form
     - Assert URL validation error shown

   - `auto-normalizes URL on blur`:
     - Enter 'example.com' (no protocol)
     - Blur the field
     - Assert value is now 'https://example.com'

   - `enforces company name max length`:
     - Enter 201 character name
     - Submit form
     - Assert length validation error shown

2. **Test suite: AddCompany Advanced Options**
   - `hides advanced options by default`:
     - Assert max pages slider not visible
     - Assert analysis mode select not visible

   - `shows advanced options when toggled`:
     - Click "Advanced Options" toggle
     - Assert max pages slider now visible
     - Assert analysis mode select now visible

   - `quick mode presets correct values`:
     - Open advanced options
     - Select 'quick' analysis mode
     - Assert maxPages is 50
     - Assert followLinkedIn is false

3. **Test suite: AddCompany Submission**
   - `calls mutation with correct data`:
     - Fill in valid form data
     - Submit form
     - Assert mutateAsync called with correct payload

   - `shows loading state during submission`:
     - Mock isPending = true
     - Assert button shows "Starting Analysis..."
     - Assert button is disabled

   - `redirects on successful submission`:
     - Mock successful mutation response
     - Submit form
     - Assert navigation to progress page

Wrap component in necessary providers (QueryClient, BrowserRouter, ToastProvider).
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/AddCompany.test.tsx 2>&1 | tail -30
```
  </verify>
  <done>AddCompany component tests pass, verifying UI-01 requirement (company submission form with validation).</done>
</task>

<task type="auto">
  <name>Task 2: Create Dashboard component tests</name>
  <files>frontend/src/__tests__/Dashboard.test.tsx</files>
  <action>
Create component tests for Dashboard in `frontend/src/__tests__/Dashboard.test.tsx`:

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { BrowserRouter } from 'react-router-dom';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import Dashboard from '../pages/Dashboard';

// Mock data
const mockCompanies = [
  {
    id: '1',
    companyName: 'Acme Corp',
    websiteUrl: 'https://acme.com',
    status: 'completed',
    totalTokensUsed: 5000,
    estimatedCost: 0.05,
    createdAt: '2024-01-15T10:00:00Z',
  },
  {
    id: '2',
    companyName: 'Beta Inc',
    websiteUrl: 'https://beta.com',
    status: 'in_progress',
    totalTokensUsed: 1000,
    estimatedCost: 0.01,
    createdAt: '2024-01-16T10:00:00Z',
  },
];

vi.mock('../hooks/useCompanies', () => ({
  useCompanies: vi.fn(() => ({
    data: {
      data: mockCompanies,
      meta: { total: 2, page: 1, pageSize: 10, totalPages: 1 },
    },
    isLoading: false,
    error: null,
    refetch: vi.fn(),
  })),
  useDeleteCompany: vi.fn(() => ({
    mutateAsync: vi.fn(),
    isPending: false,
  })),
}));
```

1. **Test suite: Dashboard Company List**
   - `renders company table with data`:
     - Assert 'Acme Corp' visible in table
     - Assert 'Beta Inc' visible in table
     - Assert website URLs visible

   - `displays correct status badges`:
     - Assert 'completed' badge visible for Acme
     - Assert 'in_progress' badge visible for Beta

   - `shows token usage and cost`:
     - Assert formatted token count (5K) visible
     - Assert formatted cost ($0.0500) visible

   - `shows empty state when no companies`:
     - Mock empty data array
     - Assert "No companies found" message
     - Assert "Add Your First Company" button visible

2. **Test suite: Dashboard Filtering**
   - `filters by status`:
     - Select 'completed' from status dropdown
     - Assert filter value updated
     - (Mock refetch to verify query param)

   - `searches by company name`:
     - Type 'acme' in search field
     - Assert search input has value
     - (Mock to verify search query)

   - `sorts by different columns`:
     - Click on sortable column header
     - Assert sort direction toggles

3. **Test suite: Dashboard Pagination**
   - `shows correct pagination info`:
     - Assert "Showing 2 of 2 companies" visible
     - Assert "Page 1 of 1" visible

   - `disables previous on first page`:
     - Assert Previous button is disabled

   - `enables navigation when multiple pages`:
     - Mock 25 total with 10 per page
     - Assert Next button is enabled
     - Assert "Page 1 of 3" visible

4. **Test suite: Dashboard Actions**
   - `shows View Progress for in_progress companies`:
     - Assert 'View Progress' link visible for Beta Inc

   - `shows View Results and Export for completed`:
     - Assert 'View Results' link visible for Acme Corp
     - Assert 'Export' button visible for Acme Corp

   - `opens delete confirmation modal`:
     - Click Delete button
     - Assert modal opens with company name
     - Assert Cancel and Delete buttons in modal

5. **Test suite: Dashboard Loading/Error States**
   - `shows skeleton during loading`:
     - Mock isLoading = true
     - Assert skeleton elements visible

   - `shows error state with retry`:
     - Mock error state
     - Assert error message visible
     - Assert Retry button visible
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/Dashboard.test.tsx 2>&1 | tail -30
```
  </verify>
  <done>Dashboard component tests pass, verifying UI-02 requirement (company list with status badges).</done>
</task>

</tasks>

<verification>
Run all frontend component tests:

```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run 2>&1 | tail -40
```

Expected: All component tests pass, verifying UI-01 and UI-02 requirements.
</verification>

<success_criteria>
- [ ] AddCompany tests verify form validation and submission
- [ ] AddCompany tests verify URL normalization
- [ ] Dashboard tests verify company list display
- [ ] Dashboard tests verify filtering and pagination
- [ ] Dashboard tests verify status badge rendering
- [ ] All tests pass with existing implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-web-crawling/01-04-SUMMARY.md`
</output>
