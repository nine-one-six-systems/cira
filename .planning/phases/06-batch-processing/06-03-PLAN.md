---
phase: 06-batch-processing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_batch_edge_cases.py
autonomous: true

must_haves:
  truths:
    - "Batch upload handles CSV encoding edge cases correctly"
    - "Large CSV files are processed without memory issues"
    - "Special characters in company names are preserved"
    - "Concurrent batch operations don't cause race conditions"
    - "Batch queue handles edge cases in scheduling"
  artifacts:
    - path: "backend/tests/test_batch_edge_cases.py"
      provides: "Edge case tests for batch processing robustness"
      min_lines: 180
  key_links:
    - from: "CSV parsing"
      to: "csv.DictReader"
      via: "Python stdlib"
      pattern: "csv\\.DictReader"
    - from: "Batch scheduling"
      to: "BatchQueueService"
      via: "fair scheduling"
      pattern: "schedule_next_from_all_batches"
    - from: "Company creation"
      to: "process_csv_row"
      via: "validation"
      pattern: "validate_url_format"
---

<objective>
Create edge case tests for batch processing that verify robustness against unusual inputs and concurrent operations.

Purpose: Ensure batch processing handles real-world edge cases like encoding issues, large files, special characters, and concurrent access without failures.

Output: Edge case test file covering CSV parsing edge cases and batch queue robustness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-batch-processing/06-RESEARCH.md
@backend/app/api/routes/batch.py
@backend/app/services/batch_queue_service.py
@backend/tests/test_batch_api.py
@backend/tests/test_batch_queue_service.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV parsing edge case tests</name>
  <files>backend/tests/test_batch_edge_cases.py</files>
  <action>
Create edge case tests for batch processing at `backend/tests/test_batch_edge_cases.py`:

1. **Test class: TestCsvEncodingEdgeCases**

   - `test_csv_with_utf8_bom`:
     - Create CSV with UTF-8 BOM (bytes \xef\xbb\xbf at start)
     - Upload to /companies/batch
     - Assert companies created correctly despite BOM
     - Assert company_name column detected properly

   - `test_csv_with_unicode_company_names`:
     - Create CSV with international characters:
       - "Acme Corp" (ASCII)
       - "Cafe Muller" with umlaut
       - "Tokyo Inc" (can include Japanese if implementation supports)
       - Chinese/Korean characters
     - Assert all names preserved correctly in database

   - `test_csv_with_emoji_in_name`:
     - Create CSV with emoji in company name (if allowed)
     - Assert either preserved or gracefully rejected

   - `test_csv_with_special_chars_in_url`:
     - Test URLs with encoded special characters
     - Test URLs with query parameters
     - Assert URL validation handles these correctly

2. **Test class: TestCsvFormatEdgeCases**

   - `test_csv_with_empty_rows_in_middle`:
     - Create CSV with blank lines between data rows
     - Assert blank rows skipped, valid rows processed

   - `test_csv_with_extra_whitespace`:
     - Create CSV with leading/trailing spaces in values
     - Assert whitespace is trimmed

   - `test_csv_with_quoted_fields`:
     - Create CSV with quoted fields containing commas:
       - `"Acme, Corp","https://acme.com","Tech, Finance"`
     - Assert commas inside quotes not treated as delimiters

   - `test_csv_with_extra_columns`:
     - Create CSV with columns beyond required (notes, contact, etc.)
     - Assert extra columns ignored, required columns processed

   - `test_csv_with_missing_optional_columns`:
     - Create CSV with only company_name and website_url (no industry)
     - Assert companies created with null/empty industry

   - `test_csv_with_windows_line_endings`:
     - Create CSV with \r\n line endings (CRLF)
     - Assert parsing handles Windows-style endings

   - `test_csv_with_mixed_line_endings`:
     - Create CSV mixing \n and \r\n
     - Assert all rows parsed correctly

3. **Test class: TestLargeFileHandling**

   - `test_csv_with_100_rows`:
     - Generate and upload 100-row CSV
     - Assert all 100 companies created
     - Assert no timeout or memory issues

   - `test_csv_with_500_rows`:
     - Generate and upload 500-row CSV
     - Assert all companies created
     - Note: existing test covers 105, this extends coverage

   - `test_csv_memory_efficiency`:
     - Upload large CSV
     - Assert response time reasonable (< 10 seconds)
     - Assert memory doesn't spike excessively

4. **Test class: TestCompanyNameEdgeCases**

   - `test_company_name_max_length`:
     - Create company with exactly 200 char name (max)
     - Assert accepted

   - `test_company_name_over_max_length`:
     - Create company with 201 char name
     - Assert rejected with "exceeds 200 characters" error

   - `test_company_name_with_special_chars`:
     - Test names with: & @ # $ % ^ * ( ) ! ?
     - Assert accepted (these are valid in company names)

   - `test_company_name_with_quotes`:
     - Test names with single and double quotes
     - Assert CSV parsing handles correctly

5. **Test class: TestUrlValidationEdgeCases**

   - `test_url_with_port`:
     - Test URL like https://example.com:8080
     - Assert valid

   - `test_url_with_path`:
     - Test URL like https://example.com/about/us
     - Assert valid

   - `test_url_with_subdomain`:
     - Test URL like https://www.example.com
     - Assert valid

   - `test_url_with_ip_address`:
     - Test URL with IP: http://192.168.1.1
     - Assert valid or explicitly rejected

   - `test_url_normalization`:
     - Test URL without protocol: example.com
     - Assert https:// is added (per existing behavior)

Each test should have docstring with BAT-01, BAT-02 traceability where applicable.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_edge_cases.py -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>CSV parsing edge case tests verify batch upload handles unusual inputs correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create batch queue edge case tests</name>
  <files>backend/tests/test_batch_edge_cases.py</files>
  <action>
Add batch queue edge case tests to `backend/tests/test_batch_edge_cases.py`:

1. **Test class: TestBatchSchedulingEdgeCases**

   - `test_schedule_with_no_pending_companies`:
     - Create batch with all COMPLETED companies
     - Call schedule_next_from_all_batches()
     - Assert 0 companies scheduled

   - `test_schedule_respects_global_limit`:
     - Create batch with 10 pending companies
     - Set GLOBAL_MAX_CONCURRENT to 3
     - Call scheduling
     - Assert only 3 companies started

   - `test_schedule_with_multiple_empty_batches`:
     - Create 3 batches with no pending companies
     - Call scheduling
     - Assert no errors, 0 scheduled

   - `test_batch_completion_with_all_failed`:
     - Create batch where all companies FAILED
     - Trigger status update
     - Assert batch status is COMPLETED (not stuck)

2. **Test class: TestBatchConcurrencyEdgeCases**

   - `test_pause_during_scheduling`:
     - Start batch processing
     - Immediately pause
     - Assert clean state transition

   - `test_double_start_batch`:
     - Create pending batch
     - Call start twice
     - Assert second call returns appropriate error (already processing)

   - `test_double_pause_batch`:
     - Create processing batch
     - Pause it
     - Try to pause again
     - Assert appropriate response

   - `test_cancel_then_resume_attempt`:
     - Cancel a batch
     - Try to resume
     - Assert rejected (cannot resume cancelled)

3. **Test class: TestBatchProgressEdgeCases**

   - `test_progress_with_zero_companies`:
     - Create batch with total_companies=0
     - Get progress
     - Assert progress_percentage is 0 or 100, no division by zero

   - `test_progress_all_failed`:
     - Create batch with all FAILED companies
     - Get progress
     - Assert 100% progress (finished, even if failed)

   - `test_progress_mixed_terminal_states`:
     - Create batch with COMPLETED, FAILED, CANCELLED mix
     - Assert correct percentage calculation

4. **Test class: TestBatchCleanupEdgeCases**

   - `test_cleanup_preserves_active_batches`:
     - Create old PROCESSING batch
     - Create old COMPLETED batch
     - Run cleanup
     - Assert PROCESSING batch preserved, COMPLETED deleted

   - `test_cleanup_handles_no_old_batches`:
     - Create only recent batches
     - Run cleanup
     - Assert 0 cleaned, no errors

Mock job_service throughout to avoid actual task dispatch.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_edge_cases.py -v --tb=short 2>&1 | tail -40
```
  </verify>
  <done>Batch queue edge case tests verify scheduling and state management robustness.</done>
</task>

</tasks>

<verification>
Run all batch edge case tests:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_edge_cases.py -v
```

Expected: All tests pass, demonstrating batch processing handles edge cases gracefully.
</verification>

<success_criteria>
- [ ] CSV encoding tests cover BOM, unicode, special characters
- [ ] CSV format tests cover empty rows, whitespace, quoting
- [ ] Large file tests verify memory efficiency
- [ ] Company name and URL validation edge cases covered
- [ ] Batch scheduling edge cases covered
- [ ] Concurrency edge cases verify clean state transitions
- [ ] All tests pass with existing implementation
- [ ] Tests documented with requirement traceability
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-processing/06-03-SUMMARY.md`
</output>
