---
phase: 04-state-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_control_api_integration.py
autonomous: true

must_haves:
  truths:
    - "POST /companies/:id/pause pauses in-progress job and returns checkpoint status"
    - "POST /companies/:id/resume resumes paused job with resumedFrom data"
    - "GET /companies/:id/progress returns real-time progress with all required fields"
    - "Pause endpoint returns 422 for non-in_progress companies"
    - "Resume endpoint returns 422 for non-paused companies"
    - "Progress endpoint returns 404 for non-existent company"
  artifacts:
    - path: "backend/tests/test_control_api_integration.py"
      provides: "Integration tests for control and progress API endpoints"
      min_lines: 200
  key_links:
    - from: "POST /pause"
      to: "CompanyStatus.PAUSED"
      via: "pause_company()"
      pattern: "pause_company|CompanyStatus\\.PAUSED"
    - from: "POST /resume"
      to: "CompanyStatus.IN_PROGRESS"
      via: "resume_company()"
      pattern: "resume_company|CompanyStatus\\.IN_PROGRESS"
    - from: "GET /progress"
      to: "ProgressResponse schema"
      via: "get_progress()"
      pattern: "ProgressResponse|get_progress"
---

<objective>
Create API integration tests for the control endpoints (pause, resume) and progress endpoint that verify correct HTTP behavior and response formats.

Purpose: Validate that API-05 (progress endpoint), API-06 (pause endpoint), and API-07 (resume endpoint) work correctly by testing through the Flask test client.

Output: API integration test file covering all control and progress endpoint behaviors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-state-management/04-RESEARCH.md
@backend/app/api/routes/control.py
@backend/app/api/routes/progress.py
@backend/app/schemas/company.py
@backend/tests/conftest.py
@backend/tests/test_api_crawl_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create control API integration tests</name>
  <files>backend/tests/test_control_api_integration.py</files>
  <action>
Create API integration tests at `backend/tests/test_control_api_integration.py`:

1. **Test class: TestPauseEndpoint (API-06)**

   - `test_pause_returns_success_for_in_progress_company` (API-06):
     - Create company with status='in_progress'
     - POST /api/v1/companies/{id}/pause
     - Assert 200 response
     - Assert data.status == 'paused'
     - Assert data.checkpointSaved is boolean
     - Assert data.pausedAt is ISO timestamp

   - `test_pause_updates_company_status_to_paused`:
     - Create in_progress company
     - POST /api/v1/companies/{id}/pause
     - GET /api/v1/companies/{id}
     - Assert company.status == 'paused'

   - `test_pause_saves_checkpoint_data`:
     - Create in_progress company with active crawl session (5 pages crawled, 3 queued)
     - POST /api/v1/companies/{id}/pause
     - Assert data.checkpointSaved == True
     - Verify checkpoint data in database

   - `test_pause_returns_422_for_paused_company`:
     - Create company with status='paused'
     - POST /api/v1/companies/{id}/pause
     - Assert 422 response
     - Assert error.code == 'INVALID_STATE'
     - Assert error includes currentStatus

   - `test_pause_returns_422_for_completed_company`:
     - Create company with status='completed'
     - POST /api/v1/companies/{id}/pause
     - Assert 422 response

   - `test_pause_returns_422_for_pending_company`:
     - Create company with status='pending'
     - POST /api/v1/companies/{id}/pause
     - Assert 422 response

   - `test_pause_returns_404_for_nonexistent_company`:
     - POST /api/v1/companies/nonexistent-uuid/pause
     - Assert 404 response
     - Assert error.code == 'NOT_FOUND'

   - `test_pause_sets_paused_at_timestamp`:
     - Create in_progress company
     - POST /api/v1/companies/{id}/pause
     - Assert data.pausedAt is recent (within 5 seconds)

2. **Test class: TestResumeEndpoint (API-07)**

   - `test_resume_returns_success_for_paused_company` (API-07):
     - Create company with status='paused', paused_at set
     - POST /api/v1/companies/{id}/resume
     - Assert 200 response
     - Assert data.status == 'in_progress'
     - Assert data.resumedFrom has pagesCrawled, entitiesExtracted, phase

   - `test_resume_updates_company_status_to_in_progress`:
     - Create paused company
     - POST /api/v1/companies/{id}/resume
     - GET /api/v1/companies/{id}
     - Assert company.status == 'in_progress'

   - `test_resume_returns_resumedFrom_with_progress`:
     - Create paused company with checkpoint (10 pages, 25 entities)
     - POST /api/v1/companies/{id}/resume
     - Assert data.resumedFrom.pagesCrawled == 10
     - Assert data.resumedFrom.entitiesExtracted >= 0
     - Assert data.resumedFrom.phase is valid phase

   - `test_resume_returns_422_for_in_progress_company`:
     - Create company with status='in_progress'
     - POST /api/v1/companies/{id}/resume
     - Assert 422 response
     - Assert error.code == 'INVALID_STATE'

   - `test_resume_returns_422_for_completed_company`:
     - Create company with status='completed'
     - POST /api/v1/companies/{id}/resume
     - Assert 422 response

   - `test_resume_returns_422_for_pending_company`:
     - Create company with status='pending'
     - POST /api/v1/companies/{id}/resume
     - Assert 422 response

   - `test_resume_returns_404_for_nonexistent_company`:
     - POST /api/v1/companies/nonexistent-uuid/resume
     - Assert 404 response

   - `test_resume_clears_paused_at`:
     - Create paused company with paused_at set
     - POST /api/v1/companies/{id}/resume
     - GET /api/v1/companies/{id}
     - Assert company.pausedAt is null

   - `test_resume_accumulates_paused_duration`:
     - Create paused company with paused_at = 5 minutes ago
     - POST /api/v1/companies/{id}/resume
     - Verify total_paused_duration_ms increased

3. **Test class: TestProgressEndpoint (API-05)**

   - `test_progress_returns_all_required_fields` (API-05):
     - Create in_progress company
     - GET /api/v1/companies/{id}/progress
     - Assert 200 response
     - Assert data has: companyId, status, phase, pagesCrawled, pagesTotal, entitiesExtracted, tokensUsed, timeElapsed

   - `test_progress_returns_current_activity`:
     - Create in_progress company with processing_phase='crawling'
     - GET /api/v1/companies/{id}/progress
     - Assert data.currentActivity contains 'crawling' or similar

   - `test_progress_returns_estimated_time_remaining`:
     - Create company with pages_crawled=10, pages_queued=10, started_at=2min ago
     - GET /api/v1/companies/{id}/progress
     - Assert data.estimatedTimeRemaining > 0

   - `test_progress_handles_company_with_no_session`:
     - Create company with no crawl session
     - GET /api/v1/companies/{id}/progress
     - Assert 200 response
     - Assert pagesCrawled == 0, pagesTotal == 0

   - `test_progress_returns_404_for_nonexistent_company`:
     - GET /api/v1/companies/nonexistent-uuid/progress
     - Assert 404 response

   - `test_progress_returns_paused_status_when_paused`:
     - Create paused company
     - GET /api/v1/companies/{id}/progress
     - Assert data.status == 'paused'

   - `test_progress_excludes_paused_time_from_elapsed`:
     - Create company with started_at=10min ago, total_paused_duration_ms=300000 (5min)
     - GET /api/v1/companies/{id}/progress
     - Assert data.timeElapsed ~= 5min (not 10min)

   - `test_progress_returns_null_estimated_when_no_progress`:
     - Create company with pages_crawled=0
     - GET /api/v1/companies/{id}/progress
     - Assert data.estimatedTimeRemaining is null

4. **Test class: TestResponseFormats**

   - `test_pause_response_matches_schema`:
     - POST /api/v1/companies/{id}/pause
     - Validate response against PauseResponse schema fields

   - `test_resume_response_matches_schema`:
     - POST /api/v1/companies/{id}/resume
     - Validate response against ResumeResponse schema fields

   - `test_progress_response_matches_schema`:
     - GET /api/v1/companies/{id}/progress
     - Validate response against ProgressResponse schema fields

   - `test_timestamps_in_iso_format`:
     - Assert pausedAt, resumedAt in ISO 8601 format

5. Use `app` fixture and `client` fixture from conftest.py for Flask test client.

6. Each test should create its own test data and be independent.

7. Create helper functions for common operations:
   - `create_in_progress_company(db)` - Company ready to pause
   - `create_paused_company(db)` - Company ready to resume
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_control_api_integration.py -v --tb=short 2>&1 | head -80
```
  </verify>
  <done>All API integration tests pass, verifying API-05, API-06, and API-07 requirements are met by existing implementation.</done>
</task>

</tasks>

<verification>
Run API integration tests to verify endpoint behavior:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_control_api_integration.py -v
```

Expected: All tests pass, demonstrating control and progress endpoints satisfy API-05, API-06, API-07 requirements.
</verification>

<success_criteria>
- [ ] Tests cover POST /companies/:id/pause endpoint (API-06)
- [ ] Tests cover POST /companies/:id/resume endpoint (API-07)
- [ ] Tests cover GET /companies/:id/progress endpoint (API-05)
- [ ] State transition validation tested (422 for invalid states)
- [ ] 404 responses for non-existent companies tested
- [ ] Response format matches schemas
- [ ] Paused duration tracking tested
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-02-SUMMARY.md`
</output>
