---
phase: 05-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_export_api_integration.py
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/companies/:id/export returns correct content-type for each format"
    - "API returns 422 for non-COMPLETED companies"
    - "API returns 404 for non-existent company or version"
    - "API returns 400 for missing or invalid format parameter"
    - "Content-Disposition header has correct filename and extension"
    - "Security headers (X-Content-Type-Options, Cache-Control) are set"
    - "Version parameter selects specific analysis version"
    - "includeRawData parameter controls JSON entity/page inclusion"
  artifacts:
    - path: "backend/tests/test_export_api_integration.py"
      provides: "Integration tests for export API endpoint behavior"
      min_lines: 150
  key_links:
    - from: "GET /export endpoint"
      to: "generate_export()"
      via: "format parameter dispatch"
      pattern: "generate_export.*format"
    - from: "Response headers"
      to: "get_secure_download_headers()"
      via: "security middleware"
      pattern: "Content-Disposition|X-Content-Type-Options"
    - from: "Version parameter"
      to: "Analysis.query.filter_by"
      via: "version lookup"
      pattern: "version_number"
---

<objective>
Create integration tests for the export API endpoint that verify HTTP behavior, content types, headers, and parameter handling.

Purpose: Validate that the GET /api/v1/companies/:id/export endpoint correctly handles all parameter combinations and returns properly formatted responses with security headers (API-08).

Output: API integration test file covering all export endpoint behaviors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-export/05-RESEARCH.md
@backend/app/api/routes/export.py
@backend/app/middleware/security.py
@backend/tests/test_export_api.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export API integration tests</name>
  <files>backend/tests/test_export_api_integration.py</files>
  <action>
Create integration tests for the export API endpoint in `backend/tests/test_export_api_integration.py`:

1. **Test class: TestExportFormatResponses (API-08)**

   - `test_markdown_response_content_type` (API-08, EXP-01):
     - Create completed company with analysis
     - GET /api/v1/companies/{id}/export?format=markdown
     - Assert status 200
     - Assert content_type contains "text/markdown"
     - Assert response body starts with "# " (markdown heading)

   - `test_word_response_content_type` (API-08, EXP-02):
     - Create completed company
     - GET /api/v1/companies/{id}/export?format=word
     - Assert status 200
     - Assert content_type contains "openxmlformats"
     - Assert response body starts with PK (ZIP/DOCX magic bytes)

   - `test_pdf_response_content_type` (API-08, EXP-03):
     - Create completed company
     - GET /api/v1/companies/{id}/export?format=pdf
     - Assert status 200
     - Assert content_type is "application/pdf"
     - Assert response body starts with %PDF (PDF magic bytes)

   - `test_json_response_content_type` (API-08, EXP-04):
     - Create completed company
     - GET /api/v1/companies/{id}/export?format=json
     - Assert status 200
     - Assert content_type contains "application/json"
     - Assert response body is valid JSON with company and analysis keys

2. **Test class: TestExportContentDisposition (API-08)**

   - `test_filename_includes_company_name`:
     - Create company named "Acme Corp"
     - GET export in markdown format
     - Assert Content-Disposition header contains "Acme"
     - Assert filename ends with ".md"

   - `test_filename_extension_matches_format`:
     - Test each format (markdown -> .md, word -> .docx, pdf -> .pdf, json -> .json)
     - Assert correct extension in Content-Disposition

   - `test_filename_sanitized_for_special_chars`:
     - Create company with name "Test / Company & Inc."
     - GET export
     - Assert filename has no "/" or "\" characters

3. **Test class: TestExportSecurityHeaders (API-08)**

   - `test_nosniff_header_present`:
     - GET export
     - Assert X-Content-Type-Options header is "nosniff"

   - `test_cache_control_header_present`:
     - GET export
     - Assert Cache-Control header contains "no-cache" or "no-store"

   - `test_all_formats_have_security_headers`:
     - Test each format
     - Assert both security headers present on all responses

4. **Test class: TestExportVersionParameter (API-08)**

   - `test_export_latest_version_by_default`:
     - Create company with 2 analysis versions
     - GET export without version parameter
     - Assert content from version 2 (latest)

   - `test_export_specific_version_1`:
     - Create company with 2 analysis versions
     - GET export?format=json&version=1
     - Assert versionNumber is 1 in JSON response

   - `test_export_specific_version_2`:
     - Create company with 2 analysis versions
     - GET export?format=json&version=2
     - Assert versionNumber is 2 in JSON response

   - `test_export_nonexistent_version_returns_404`:
     - Create company with 1 analysis
     - GET export?format=json&version=99
     - Assert status 404
     - Assert error code is "NOT_FOUND"

5. **Test class: TestExportIncludeRawDataParameter (API-08)**

   - `test_json_includes_entities_by_default`:
     - Create company with entities
     - GET export?format=json
     - Assert "entities" array present in response

   - `test_json_includes_pages_by_default`:
     - Create company with pages
     - GET export?format=json
     - Assert "pages" array present in response

   - `test_json_excludes_entities_when_false`:
     - GET export?format=json&includeRawData=false
     - Assert "entities" NOT in response

   - `test_json_excludes_pages_when_false`:
     - GET export?format=json&includeRawData=false
     - Assert "pages" NOT in response

6. **Test class: TestExportStatusValidation (API-08)**

   - `test_export_pending_company_returns_422`:
     - Create company with status=PENDING
     - GET export
     - Assert status 422
     - Assert error code is "CONFLICT"

   - `test_export_in_progress_company_returns_422`:
     - Create company with status=IN_PROGRESS
     - GET export
     - Assert status 422

   - `test_export_paused_company_returns_422`:
     - Create company with status=PAUSED
     - GET export
     - Assert status 422

   - `test_export_failed_company_returns_422`:
     - Create company with status=FAILED
     - GET export
     - Assert status 422

   - `test_export_completed_company_succeeds`:
     - Create company with status=COMPLETED
     - GET export
     - Assert status 200

7. Use `client` fixture from conftest.py for HTTP requests.

8. Each test should have docstring with requirement ID (API-08, EXP-XX) traceability.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_api_integration.py -v --tb=short 2>&1 | head -80
```
  </verify>
  <done>All API integration tests pass, verifying API-08 requirement for export endpoint.</done>
</task>

<task type="auto">
  <name>Task 2: Add case-insensitive and error handling tests</name>
  <files>backend/tests/test_export_api_integration.py</files>
  <action>
Add additional API integration tests to the existing file:

1. **Test class: TestExportCaseInsensitivity (API-08)**

   - `test_uppercase_format_accepted`:
     - GET export?format=MARKDOWN
     - Assert status 200

   - `test_mixed_case_format_accepted`:
     - GET export?format=Pdf
     - Assert status 200

   - `test_word_format_variations`:
     - Test "word", "WORD", "Word" all return 200 with docx content-type

2. **Test class: TestExportErrorResponses (API-08)**

   - `test_missing_format_returns_400`:
     - GET export without format parameter
     - Assert status 400
     - Assert error code is "VALIDATION_ERROR"
     - Assert error message mentions "format"

   - `test_invalid_format_returns_400`:
     - GET export?format=xlsx
     - Assert status 400
     - Assert error code is "VALIDATION_ERROR"

   - `test_nonexistent_company_returns_404`:
     - GET /api/v1/companies/nonexistent-uuid/export?format=markdown
     - Assert status 404
     - Assert error code is "NOT_FOUND"

   - `test_invalid_version_format_returns_400`:
     - GET export?format=json&version=abc
     - Assert status 400
     - Assert error mentions version

3. Each test should document the specific API-08 behavior being verified.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_api_integration.py -v --tb=short 2>&1 | tail -30
```
  </verify>
  <done>All API integration tests pass, covering format variations and error responses.</done>
</task>

</tasks>

<verification>
Run all export API integration tests:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_api_integration.py -v
```

Expected: All tests pass, demonstrating API-08 requirement is fully satisfied.
</verification>

<success_criteria>
- [ ] Tests cover all four export format content-types
- [ ] Tests verify Content-Disposition headers with correct filenames
- [ ] Tests verify security headers (X-Content-Type-Options, Cache-Control)
- [ ] Tests verify version parameter behavior
- [ ] Tests verify includeRawData parameter for JSON
- [ ] Tests verify status validation (only COMPLETED exports allowed)
- [ ] Tests verify case-insensitive format handling
- [ ] Tests verify error responses (400, 404, 422)
- [ ] All tests pass with existing implementation
- [ ] Tests documented with API-08 requirement traceability
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-02-SUMMARY.md`
</output>
