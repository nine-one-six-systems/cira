---
phase: 03-ai-analysis
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/__tests__/AnalysisUI.test.tsx
autonomous: true

must_haves:
  truths:
    - "Progress tracker shows current analysis phase"
    - "Current activity text updates during analysis"
    - "Token counter displays input/output tokens and cost"
    - "Analysis viewer renders markdown content"
    - "Collapsible sections allow expanding/collapsing analysis parts"
    - "Loading states shown while fetching data"
  artifacts:
    - path: "frontend/src/__tests__/AnalysisUI.test.tsx"
      provides: "Component tests for analysis UI"
      min_lines: 200
  key_links:
    - from: "CompanyProgress"
      to: "useProgress"
      via: "React Query hook"
      pattern: "useProgress"
    - from: "CompanyResults"
      to: "useTokens"
      via: "React Query hook"
      pattern: "useTokens"
    - from: "CompanyResults"
      to: "analysis.sections"
      via: "markdown rendering"
      pattern: "analysis\\.sections|ReactMarkdown"
---

<objective>
Create frontend component tests for the analysis UI (progress tracker, token counter, analysis viewer).

Purpose: Verify that UI-03 (real-time progress during analysis) and UI-04 (completed analysis with markdown rendering) work correctly by testing user-visible components.

Output: React Testing Library tests covering progress display, token counter, and analysis viewer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ai-analysis/03-RESEARCH.md
@frontend/src/pages/CompanyProgress.tsx
@frontend/src/pages/CompanyResults.tsx
@frontend/src/hooks/useCompanies.ts
@frontend/src/__tests__/AddCompany.test.tsx
@frontend/src/__tests__/Dashboard.test.tsx
@frontend/src/__tests__/EntitiesTab.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis UI component tests</name>
  <files>frontend/src/__tests__/AnalysisUI.test.tsx</files>
  <action>
Create component tests at `frontend/src/__tests__/AnalysisUI.test.tsx`:

1. **Setup and Mocks**
   - Import React Testing Library utilities (render, screen, fireEvent, waitFor)
   - Import vi from vitest for mocking
   - Mock useCompanies hooks (useCompany, useProgress, useTokens, useVersions, useEntities, usePages)
   - Mock react-router-dom (useParams returns test company ID)
   - Create mock progress data with current section and percentage
   - Create mock tokens data with usage breakdown
   - Create mock company data with analysis sections

2. **Test describe: Progress Tracker (UI-03)**

   - `renders progress tracker during analysis`:
     - Mock company with status='analyzing'
     - Mock useProgress to return current section
     - Render CompanyProgress
     - Assert progress tracker visible
     - Assert current phase indicator shown

   - `displays current analysis section`:
     - Mock useProgress with currentSection='business_model'
     - Render CompanyProgress
     - Assert 'Business Model' or 'Analyzing business model...' visible

   - `shows progress percentage`:
     - Mock useProgress with progress=0.57 (4/7 sections)
     - Render CompanyProgress
     - Assert '57%' or '4 of 7' visible
     - Assert progress bar at ~57%

   - `updates progress in real-time`:
     - Mock useProgress with refetch capability
     - Render CompanyProgress
     - Assert polling/refetch happening (useProgress called multiple times)

   - `shows activity text describing current work`:
     - Mock useProgress with activity='Generating executive summary...'
     - Render CompanyProgress
     - Assert activity text visible

   - `transitions to results when complete`:
     - Mock company status changing from 'analyzing' to 'completed'
     - Assert redirect or results view shown

3. **Test describe: Token Counter**

   - `displays total token count`:
     - Mock useTokens with totalTokens=15000
     - Render CompanyResults (or CompanyProgress if shown there)
     - Assert '15,000 tokens' or similar visible

   - `displays input and output token breakdown`:
     - Mock useTokens with totalInputTokens=10000, totalOutputTokens=5000
     - Assert 'Input: 10,000' and 'Output: 5,000' visible

   - `displays estimated cost`:
     - Mock useTokens with estimatedCost=0.0042
     - Assert '$0.004' or '$0.0042' visible

   - `formats cost with appropriate precision`:
     - Mock useTokens with estimatedCost=0.00001
     - Assert cost displayed without rounding to $0.00

   - `shows per-section breakdown on expand`:
     - Mock useTokens with sections array
     - Click expand/details button if exists
     - Assert section names and their token counts visible

4. **Test describe: Analysis Viewer (UI-04)**

   - `renders analysis tab with sections`:
     - Mock company with analysis.sections containing all 7 sections
     - Render CompanyResults, click Analysis tab
     - Assert section headers visible (Executive Summary, Company Overview, etc.)

   - `renders markdown content correctly`:
     - Mock analysis section with markdown: '**bold** and _italic_'
     - Assert bold text rendered as <strong>
     - Assert italic text rendered as <em>

   - `renders markdown lists`:
     - Mock analysis section with bullet points
     - Assert <ul> and <li> elements rendered

   - `renders markdown headers`:
     - Mock analysis section with '## Subheading'
     - Assert h2 element rendered

   - `sections are collapsible`:
     - Render analysis with multiple sections
     - Assert all sections visible by default (or expandable)
     - Click section header to collapse
     - Assert section content hidden
     - Click again to expand
     - Assert section content visible

   - `handles code blocks in analysis`:
     - Mock analysis with fenced code block
     - Assert code element rendered
     - Assert proper formatting/highlighting

5. **Test describe: Loading States**

   - `shows skeleton while analysis loading`:
     - Mock useCompany with isLoading=true
     - Render CompanyResults
     - Assert Skeleton components visible

   - `shows progress skeleton while fetching progress`:
     - Mock useProgress with isLoading=true
     - Render CompanyProgress
     - Assert loading indicator visible

   - `shows token skeleton while fetching tokens`:
     - Mock useTokens with isLoading=true
     - Assert token counter shows loading state

6. **Test describe: Error States**

   - `shows error when analysis fetch fails`:
     - Mock useCompany with error
     - Render CompanyResults
     - Assert error message displayed

   - `shows retry option on error`:
     - Mock fetch error
     - Assert 'Retry' or 'Try again' button visible

   - `handles partial analysis (some sections failed)`:
     - Mock company with analysis where one section is null/error
     - Render CompanyResults
     - Assert available sections rendered
     - Assert failed section shows error indicator

7. **Test describe: Empty States**

   - `shows message when analysis not started`:
     - Mock company with status='crawling' (analysis not started)
     - Render CompanyResults Analysis tab
     - Assert 'Analysis not yet started' or similar message

   - `shows message when analysis has no sections`:
     - Mock company with analysis.sections = []
     - Assert appropriate empty state message

8. Use vitest patterns consistent with existing tests (EntitiesTab.test.tsx).

9. Mock hooks using vi.mock() and vi.fn() patterns.

10. Use userEvent for interactions where appropriate.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/AnalysisUI.test.tsx 2>&1 | head -60
```
  </verify>
  <done>All frontend tests pass, verifying UI-03 (progress tracker) and UI-04 (analysis viewer) work correctly.</done>
</task>

</tasks>

<verification>
Run frontend tests to verify analysis UI:

```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run
```

Expected: All tests pass, demonstrating UI-03 and UI-04 requirements are satisfied.
</verification>

<success_criteria>
- [ ] Progress tracker shows current phase and percentage
- [ ] Activity text updates during analysis
- [ ] Token counter displays tokens and cost
- [ ] Analysis viewer renders markdown correctly
- [ ] Sections can be collapsed/expanded
- [ ] Loading states shown appropriately
- [ ] Error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-analysis/03-04-SUMMARY.md`
</output>
