---
phase: 06-batch-processing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_batch_api_integration.py
autonomous: true

must_haves:
  truths:
    - "Batch API endpoints handle all HTTP scenarios correctly"
    - "Delete company endpoint cascades to all related data"
    - "Batch control operations (start/pause/resume/cancel) work correctly"
    - "API responses follow consistent schema"
    - "Error responses include appropriate codes and messages"
  artifacts:
    - path: "backend/tests/test_batch_api_integration.py"
      provides: "Integration tests for batch and delete API endpoints"
      min_lines: 200
  key_links:
    - from: "POST /companies/batch"
      to: "batch.py batch_upload"
      via: "route handler"
      pattern: "@batch_bp.route.*batch.*POST"
    - from: "DELETE /companies/:id"
      to: "companies.py delete_company"
      via: "route handler"
      pattern: "@companies_bp.route.*DELETE"
    - from: "Batch control endpoints"
      to: "batch_queue_service"
      via: "service calls"
      pattern: "batch_queue_service\\.(start|pause|resume|cancel)"
---

<objective>
Create integration tests for batch-related API endpoints including batch upload, batch control operations, and company deletion.

Purpose: Validate that API layer correctly handles HTTP requests, returns proper response schemas, and integrates with service layer for batch and delete operations.

Output: API integration test file covering batch endpoints and delete cascade.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-batch-processing/06-RESEARCH.md
@backend/app/api/routes/batch.py
@backend/app/api/routes/batch_queue.py
@backend/app/api/routes/companies.py
@backend/tests/test_batch_api.py
@backend/tests/test_batch_queue_api.py
@backend/tests/test_companies_api.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch API integration tests</name>
  <files>backend/tests/test_batch_api_integration.py</files>
  <action>
Create integration tests for batch API endpoints at `backend/tests/test_batch_api_integration.py`:

1. **Test class: TestBatchUploadResponses (API-02)**

   - `test_successful_upload_response_schema`:
     - POST valid CSV to /companies/batch
     - Assert 201 status
     - Assert response has: success, data.totalCount, data.successful, data.failed, data.companies
     - Assert each company result has: companyName, companyId, error

   - `test_partial_success_response`:
     - POST CSV with some invalid rows
     - Assert 201 status (partial success)
     - Assert response shows correct success/fail counts
     - Assert failed rows have error messages, successful have companyId

   - `test_all_fail_response`:
     - POST CSV with all invalid rows
     - Assert 201 status
     - Assert successful=0, failed=N
     - Assert all companies have error field populated

   - `test_missing_file_error`:
     - POST to /companies/batch without file
     - Assert 400 status
     - Assert error.code = VALIDATION_ERROR

   - `test_wrong_file_type_error`:
     - POST .txt file instead of .csv
     - Assert 400 status
     - Assert error message mentions CSV

   - `test_empty_csv_error`:
     - POST empty CSV file
     - Assert 400 status
     - Assert appropriate error message

2. **Test class: TestBatchControlEndpoints**

   - `test_start_batch_success`:
     - Create pending batch with companies
     - POST /batches/{id}/start
     - Assert 200 with success=True
     - Assert batch status changed to PROCESSING

   - `test_pause_batch_success`:
     - Create processing batch
     - POST /batches/{id}/pause
     - Assert 200 with success=True
     - Assert batch status changed to PAUSED

   - `test_resume_batch_success`:
     - Create paused batch
     - POST /batches/{id}/resume
     - Assert 200 with success=True
     - Assert batch status changed to PROCESSING

   - `test_cancel_batch_success`:
     - Create processing batch
     - POST /batches/{id}/cancel
     - Assert 200 with success=True
     - Assert batch status changed to CANCELLED

   - `test_invalid_state_transitions`:
     - Try to pause completed batch -> 422
     - Try to resume processing batch -> 422
     - Try to cancel completed batch -> 422

   - `test_batch_not_found`:
     - All control endpoints with nonexistent ID -> 404

3. **Test class: TestDeleteCompanyEndpoint (API-09)**

   - `test_delete_existing_company`:
     - Create company with pages, entities, analysis
     - DELETE /companies/{id}
     - Assert 200 or 204 status
     - Assert company no longer in database

   - `test_delete_cascades_pages`:
     - Create company with Page records
     - DELETE company
     - Assert pages also deleted

   - `test_delete_cascades_entities`:
     - Create company with Entity records
     - DELETE company
     - Assert entities also deleted

   - `test_delete_cascades_analysis`:
     - Create company with Analysis record
     - DELETE company
     - Assert analysis also deleted

   - `test_delete_cascades_token_usage`:
     - Create company with TokenUsage records
     - DELETE company
     - Assert token records also deleted

   - `test_delete_nonexistent_company`:
     - DELETE /companies/nonexistent-id
     - Assert 404 status

   - `test_delete_removes_from_batch`:
     - Create company associated with batch
     - DELETE company
     - Assert batch still exists
     - Assert batch company count updated

4. **Test class: TestBatchListingEndpoints**

   - `test_list_batches_pagination`:
     - Create 10 batches
     - GET /batches?limit=3&offset=2
     - Assert returns 3 batches
     - Assert total=10

   - `test_list_batches_status_filter`:
     - Create batches with different statuses
     - GET /batches?status=processing
     - Assert only processing batches returned

   - `test_get_batch_companies`:
     - Create batch with 5 companies
     - GET /batches/{id}/companies
     - Assert returns all 5 companies

5. Use `@pytest.fixture` for app context and database setup.

6. Each test should have docstring with requirement ID traceability.

7. Mock job_service to avoid actual task dispatch for control tests.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_api_integration.py -v --tb=short 2>&1 | head -80
```
  </verify>
  <done>All API integration tests pass, verifying API-02 and API-09 requirements plus batch control operations.</done>
</task>

<task type="auto">
  <name>Task 2: Verify delete cascade works correctly</name>
  <files>backend/tests/test_batch_api_integration.py</files>
  <action>
Add comprehensive delete cascade verification tests to the TestDeleteCompanyEndpoint class:

1. **test_delete_full_cascade**:
   - Create Company with:
     - 3 Page records
     - 5 Entity records
     - 1 Analysis record with TokenUsage
     - 1 Checkpoint record (if exists)
   - Note all record IDs before delete
   - DELETE /companies/{id}
   - Query database for each related record by ID
   - Assert all are deleted (None returned)

2. **test_delete_preserves_unrelated_data**:
   - Create two companies with data
   - DELETE first company
   - Assert second company and its data still exist

3. **test_delete_handles_in_progress_company**:
   - Create company with IN_PROGRESS status
   - Verify it can still be deleted
   - Or verify appropriate error if deletion blocked

4. Import models:
   - Company, Page, Entity, Analysis, TokenUsage, Checkpoint (if exists)

5. Verify database queries use app context properly.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_api_integration.py::TestDeleteCompanyEndpoint -v --tb=short
```
  </verify>
  <done>Delete cascade tests verify API-09 completely removes company and all associated data.</done>
</task>

</tasks>

<verification>
Run all batch API integration tests:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_api_integration.py -v
```

Expected: All tests pass, verifying API-02, API-09, and batch control endpoints.
</verification>

<success_criteria>
- [ ] Batch upload response schema tests pass (API-02)
- [ ] Batch control endpoint tests pass (start, pause, resume, cancel)
- [ ] Delete cascade tests verify all related data removed (API-09)
- [ ] Batch listing and pagination tests pass
- [ ] Error response tests verify proper codes and messages
- [ ] All tests pass with existing implementation
- [ ] Tests documented with requirement traceability
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-processing/06-02-SUMMARY.md`
</output>
