---
phase: 01-web-crawling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_api_crawl_integration.py
autonomous: true

must_haves:
  truths:
    - "POST /companies creates company and returns 201 with company ID"
    - "GET /companies lists companies with status badges correctly"
    - "GET /companies/:id returns company with page count and analysis"
    - "GET /companies/:id/pages returns crawled pages for company"
  artifacts:
    - path: "backend/tests/test_api_crawl_integration.py"
      provides: "API integration tests verifying full create-to-list flow"
      min_lines: 100
  key_links:
    - from: "POST /companies"
      to: "Company model"
      via: "database insert"
      pattern: "db\\.session\\.add"
    - from: "GET /companies/:id"
      to: "Page.query"
      via: "page count aggregation"
      pattern: "Page\\.query\\.filter_by"
---

<objective>
Create API integration tests that verify the company CRUD endpoints work correctly with the crawl-related data models.

Purpose: Validate API-01, API-03, API-04 requirements and ensure the API layer correctly integrates with models and returns proper response formats.

Output: API integration test file covering the full company workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-web-crawling/01-RESEARCH.md
@backend/app/api/routes/companies.py
@backend/app/api/routes/entities.py
@backend/tests/test_companies_api.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API crawl integration tests</name>
  <files>backend/tests/test_api_crawl_integration.py</files>
  <action>
Create API integration tests in `backend/tests/test_api_crawl_integration.py` that verify the full workflow:

1. **Test class: TestCompanyCreationFlow**
   - `test_create_company_returns_correct_response_format`:
     - POST /api/v1/companies with valid data
     - Assert response has: success=true, data.companyId, data.status='pending', data.createdAt
     - Assert response Content-Type is application/json

   - `test_create_company_with_crawl_config`:
     - POST with config: maxPages=100, maxDepth=5, followLinkedIn=true
     - GET the created company
     - Assert config values are persisted correctly

   - `test_create_company_validates_url_format`:
     - POST with invalid URL formats: 'not-a-url', 'ftp://invalid.com', ''
     - Assert each returns 400 with VALIDATION_ERROR code

   - `test_create_company_rejects_duplicate_url`:
     - Create company with URL A
     - Try to create another with same URL (normalized)
     - Assert returns 409 with CONFLICT code and existingCompanyId

2. **Test class: TestCompanyListingFlow**
   - `test_list_companies_returns_pagination_meta`:
     - Create 25 companies
     - GET /api/v1/companies?page=1&pageSize=10
     - Assert meta.total=25, meta.page=1, meta.pageSize=10, meta.totalPages=3

   - `test_list_companies_filters_by_status`:
     - Create companies with different statuses (pending, completed, failed)
     - GET with status=completed filter
     - Assert only completed companies returned

   - `test_list_companies_search_by_name`:
     - Create 'Acme Corp' and 'Beta Inc'
     - GET with search=acme
     - Assert only Acme Corp returned

   - `test_list_companies_sort_options`:
     - Create companies with different names/dates
     - GET with sort=company_name&order=asc
     - Assert alphabetical order
     - GET with sort=created_at&order=desc
     - Assert newest first

3. **Test class: TestCompanyDetailFlow**
   - `test_get_company_includes_page_count`:
     - Create company, add 5 Page records directly in DB
     - GET /api/v1/companies/:id
     - Assert pageCount=5 in response

   - `test_get_company_includes_entity_count`:
     - Create company, add 10 Entity records directly in DB
     - GET /api/v1/companies/:id
     - Assert entityCount=10 in response

   - `test_get_company_includes_latest_analysis`:
     - Create company with 2 Analysis records (version 1, version 2)
     - GET /api/v1/companies/:id
     - Assert analysis.versionNumber=2 (latest)

   - `test_get_company_not_found`:
     - GET /api/v1/companies/nonexistent-uuid
     - Assert 404 with NOT_FOUND code

4. **Test class: TestPagesEndpoint**
   - `test_get_pages_returns_paginated_list`:
     - Create company with 30 pages
     - GET /api/v1/companies/:id/pages?pageSize=10
     - Assert 10 pages returned, meta.total=30

   - `test_get_pages_filters_by_type`:
     - Create pages with different page_type values
     - GET with pageType=about filter
     - Assert only about pages returned

Use the existing test fixtures from conftest.py (app, client).
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_api_crawl_integration.py -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>All API integration tests pass, verifying API-01, API-03, API-04 requirements.</done>
</task>

<task type="auto">
  <name>Task 2: Add edge case tests for API error handling</name>
  <files>backend/tests/test_api_crawl_integration.py</files>
  <action>
Add edge case tests to the existing test file:

1. **Test class: TestAPIEdgeCases**
   - `test_create_company_name_boundary_lengths`:
     - Test name with exactly 200 chars (should succeed)
     - Test name with 201 chars (should fail with VALIDATION_ERROR)

   - `test_create_company_url_normalization`:
     - Create with 'https://Example.COM/Page/'
     - Assert stored URL is normalized (lowercase host, no trailing slash)

   - `test_list_companies_invalid_page_number`:
     - GET with page=-1
     - Assert returns page 1 (clamped to valid range)
     - GET with page=9999 (beyond total)
     - Assert returns empty data array

   - `test_list_companies_page_size_capped`:
     - GET with pageSize=500
     - Assert meta.pageSize <= 100 (capped)

   - `test_get_company_invalid_uuid_format`:
     - GET /api/v1/companies/not-a-uuid
     - Assert returns 404 (not 500 server error)

   - `test_delete_company_cascades_correctly`:
     - Create company with pages, entities, analysis
     - DELETE company
     - Assert response includes deletedRecords counts
     - Verify Page, Entity, Analysis records are actually deleted from DB

2. Document each test with requirement traceability comment.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_api_crawl_integration.py::TestAPIEdgeCases -v --tb=short 2>&1
```
  </verify>
  <done>Edge case tests pass, demonstrating robust API error handling.</done>
</task>

</tasks>

<verification>
Run all API integration tests:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_api_crawl_integration.py -v
```

Expected: All tests pass, verifying API requirements API-01, API-03, API-04 are satisfied.
</verification>

<success_criteria>
- [ ] Tests cover full CRUD workflow for companies
- [ ] Tests verify pagination, filtering, sorting work correctly
- [ ] Tests verify page and entity counts are included in responses
- [ ] Edge cases tested (invalid input, boundary conditions)
- [ ] All tests pass with existing implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-web-crawling/01-02-SUMMARY.md`
</output>
