---
phase: 05-export
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/__tests__/ExportUI.test.tsx
autonomous: true

must_haves:
  truths:
    - "Export dropdown displays all four format options"
    - "Selecting a format triggers export API call"
    - "Loading state shown during export generation"
    - "Success toast displayed after successful export"
    - "Error toast displayed if export fails"
    - "Download triggered automatically after export"
    - "Export dropdown only visible for completed companies"
  artifacts:
    - path: "frontend/src/__tests__/ExportUI.test.tsx"
      provides: "UI component tests for export dropdown and download flow"
      min_lines: 150
  key_links:
    - from: "Export dropdown"
      to: "exportAnalysis()"
      via: "onChange handler"
      pattern: "exportAnalysis.*format"
    - from: "exportAnalysis()"
      to: "blob download"
      via: "createObjectURL"
      pattern: "createObjectURL|a\\.click"
    - from: "Loading state"
      to: "isExporting"
      via: "state variable"
      pattern: "isExporting|setIsExporting"
---

<objective>
Create UI component tests for the export dropdown and download flow in the CompanyResults page.

Purpose: Validate that the export UI correctly displays options, triggers downloads, and provides feedback to users (UI-06 requirement).

Output: Frontend test file with React Testing Library tests for export functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-export/05-RESEARCH.md
@frontend/src/pages/CompanyResults.tsx
@frontend/src/api/companies.ts
@frontend/src/__tests__/AnalysisUI.test.tsx
@frontend/src/__tests__/PauseResumeUI.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export UI component tests</name>
  <files>frontend/src/__tests__/ExportUI.test.tsx</files>
  <action>
Create UI component tests for export functionality in `frontend/src/__tests__/ExportUI.test.tsx`:

1. **Setup and mocks**:

   ```typescript
   import { render, screen, waitFor, within } from '@testing-library/react';
   import userEvent from '@testing-library/user-event';
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
   import { BrowserRouter, useParams } from 'react-router-dom';
   import { vi, describe, it, expect, beforeEach, type Mock } from 'vitest';
   import CompanyResults from '../pages/CompanyResults';
   import { exportAnalysis } from '../api/companies';
   import {
     useCompany,
     useEntities,
     usePages,
     useTokens,
     useVersions,
     useCompareVersions,
     useRescanCompany,
   } from '../hooks/useCompanies';
   import { useToast } from '../components/ui';
   ```

   Mock all hooks similar to AnalysisUI.test.tsx pattern:
   - `vi.mock('../hooks/useCompanies')`
   - `vi.mock('../api/companies')`
   - `vi.mock('../components/ui', async () => { ... })`
   - `vi.mock('react-router-dom', async () => { ... })`

   Create mock company data for COMPLETED status with analysis.

2. **Test class: TestExportDropdownDisplay (UI-06)**

   - `test_export_dropdown_visible_for_completed_company` (UI-06):
     - Mock useCompany to return completed company
     - Render CompanyResults
     - Assert export select/dropdown is visible
     - Assert labeled "Export" or has aria-label for export

   - `test_export_dropdown_has_all_format_options` (UI-06):
     - Mock useCompany to return completed company
     - Render CompanyResults
     - Find export dropdown
     - Assert options present: Markdown (.md), PDF (.pdf), Word (.docx), JSON (.json)

   - `test_export_dropdown_has_default_empty_selection`:
     - Render CompanyResults
     - Find export dropdown
     - Assert no format is pre-selected (empty value or placeholder)

3. **Test class: TestExportSelection (UI-06)**

   - `test_selecting_markdown_triggers_export` (UI-06):
     - Mock exportAnalysis to return a Blob
     - Render CompanyResults
     - Find and change export dropdown to "markdown"
     - Assert exportAnalysis called with (companyId, 'markdown')

   - `test_selecting_pdf_triggers_export` (UI-06):
     - Mock exportAnalysis
     - Change export dropdown to "pdf"
     - Assert exportAnalysis called with (companyId, 'pdf')

   - `test_selecting_word_triggers_export` (UI-06):
     - Change export dropdown to "word"
     - Assert exportAnalysis called with (companyId, 'word')

   - `test_selecting_json_triggers_export` (UI-06):
     - Change export dropdown to "json"
     - Assert exportAnalysis called with (companyId, 'json')

4. **Test class: TestExportLoadingState (UI-06)**

   - `test_shows_loading_during_export`:
     - Mock exportAnalysis to return slowly (use delay)
     - Select export format
     - Assert loading indicator or disabled state visible
     - (May need to check for spinner or disabled button)

   - `test_dropdown_disabled_during_export`:
     - Mock exportAnalysis to return slowly
     - Select export format
     - Assert dropdown becomes disabled while exporting

5. Each test should have docstring with UI-06 requirement traceability.

6. Use React Testing Library best practices:
   - Query by role, label, or text (not test IDs)
   - Use userEvent for interactions
   - Use waitFor for async operations
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/ExportUI.test.tsx 2>&1 | head -60
```
  </verify>
  <done>Export dropdown display and selection tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add export feedback and download tests</name>
  <files>frontend/src/__tests__/ExportUI.test.tsx</files>
  <action>
Add additional UI tests for export feedback and download flow:

1. **Test class: TestExportSuccessFeedback (UI-06)**

   - `test_success_toast_on_export_complete` (UI-06):
     - Mock exportAnalysis to resolve successfully with Blob
     - Mock showToast from useToast
     - Select export format
     - Wait for export to complete
     - Assert showToast called with { type: 'success', ... }

   - `test_download_triggered_on_success`:
     - Mock exportAnalysis to resolve with Blob
     - Mock URL.createObjectURL and document.createElement
     - Select export format
     - Wait for completion
     - Assert createObjectURL was called
     - Assert anchor element click() was triggered

   - `test_dropdown_resets_after_export`:
     - Mock exportAnalysis to resolve
     - Select "markdown" format
     - Wait for completion
     - Assert dropdown value is empty/reset

2. **Test class: TestExportErrorFeedback (UI-06)**

   - `test_error_toast_on_export_failure` (UI-06):
     - Mock exportAnalysis to reject with Error
     - Mock showToast from useToast
     - Select export format
     - Wait for error
     - Assert showToast called with { type: 'error', message: contains 'Failed' }

   - `test_dropdown_enabled_after_error`:
     - Mock exportAnalysis to reject
     - Select format
     - Wait for error
     - Assert dropdown is enabled again (not stuck in loading)

   - `test_dropdown_resets_after_error`:
     - Mock exportAnalysis to reject
     - Select format
     - Wait for error
     - Assert dropdown value is empty/reset

3. **Test class: TestExportDownloadFilename (UI-06)**

   - `test_download_filename_includes_company_name`:
     - Mock company with name "Test Corp"
     - Mock exportAnalysis to resolve
     - Select markdown format
     - Assert download link has filename containing "Test Corp" and ".md"

   - `test_word_export_uses_docx_extension`:
     - Select word format
     - Assert download filename ends with ".docx" (not ".word")

4. **Test class: TestExportVisibility (UI-06)**

   - `test_export_hidden_for_pending_company`:
     - Mock useCompany to return status='pending'
     - Render CompanyResults
     - Assert export dropdown is NOT visible or is disabled

   - `test_export_hidden_for_in_progress_company`:
     - Mock useCompany to return status='in_progress'
     - Assert export dropdown NOT visible

   - `test_export_hidden_for_failed_company`:
     - Mock useCompany to return status='failed'
     - Assert export dropdown NOT visible or disabled

5. Mock window.URL.createObjectURL and window.URL.revokeObjectURL:
   ```typescript
   global.URL.createObjectURL = vi.fn(() => 'blob:mock-url');
   global.URL.revokeObjectURL = vi.fn();
   ```

6. Each test should document UI-06 requirement coverage.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/ExportUI.test.tsx 2>&1 | tail -40
```
  </verify>
  <done>All export UI tests pass, verifying UI-06 requirement for export dropdown functionality.</done>
</task>

</tasks>

<verification>
Run all export UI tests:

```bash
cd /Users/stephenhollifield/Cira/frontend && npm test -- --run src/__tests__/ExportUI.test.tsx
```

Expected: All tests pass, demonstrating UI-06 requirement is satisfied for export functionality.
</verification>

<success_criteria>
- [ ] Tests verify export dropdown displays all format options
- [ ] Tests verify selecting format triggers API call
- [ ] Tests verify loading state during export
- [ ] Tests verify success toast and download trigger
- [ ] Tests verify error toast on failure
- [ ] Tests verify dropdown reset after export
- [ ] Tests verify export hidden for non-completed companies
- [ ] All tests pass with existing implementation
- [ ] Tests use React Testing Library best practices
- [ ] Tests documented with UI-06 requirement traceability
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-04-SUMMARY.md`
</output>
