---
phase: 02-entity-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_entities_api_integration.py
autonomous: true

must_haves:
  truths:
    - "GET /companies/:id/entities returns extracted entities"
    - "Type filter returns only entities of specified type"
    - "minConfidence filter excludes low-confidence entities"
    - "Pagination returns correct page counts and data"
    - "Entities ordered by confidence descending"
  artifacts:
    - path: "backend/tests/test_entities_api_integration.py"
      provides: "Integration tests for entities API endpoint"
      min_lines: 150
  key_links:
    - from: "GET /companies/:id/entities"
      to: "Entity model"
      via: "SQLAlchemy query"
      pattern: "Entity\\.query\\.filter"
    - from: "list_entities()"
      to: "EntityItem schema"
      via: "response serialization"
      pattern: "EntityItem"
---

<objective>
Create API integration tests for the entities endpoint that verify filtering, pagination, and response format.

Purpose: Validate that the GET /companies/:id/entities endpoint (API-10) correctly returns extracted entities with all query parameters working as expected.

Output: API integration test file covering all entity endpoint behaviors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-entity-extraction/02-RESEARCH.md
@backend/app/api/routes/entities.py
@backend/app/schemas.py
@backend/tests/conftest.py
@backend/tests/test_api_crawl_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entities API integration tests</name>
  <files>backend/tests/test_entities_api_integration.py</files>
  <action>
Create API integration tests at `backend/tests/test_entities_api_integration.py`:

1. **Test class: TestListEntities**
   - Tests for GET /api/v1/companies/:id/entities (API-10)

   - `test_list_entities_returns_empty_for_new_company`:
     - Create company with no entities
     - GET /api/v1/companies/{id}/entities
     - Assert 200 response
     - Assert data is empty array
     - Assert meta.total is 0

   - `test_list_entities_returns_entities`:
     - Create company
     - Add 5 entities of mixed types via Entity model
     - GET /api/v1/companies/{id}/entities
     - Assert 200 response
     - Assert len(data) == 5
     - Assert each entity has: id, entityType, entityValue, confidenceScore, sourceUrl

   - `test_list_entities_orders_by_confidence_descending`:
     - Create 3 entities with confidence: 0.5, 0.9, 0.7
     - GET /api/v1/companies/{id}/entities
     - Assert first entity has highest confidence (0.9)
     - Assert order is 0.9, 0.7, 0.5

   - `test_list_entities_filters_by_type`:
     - Create entities: 2 person, 2 org, 2 email
     - GET /api/v1/companies/{id}/entities?type=person
     - Assert len(data) == 2
     - Assert all entities have entityType == 'person'

   - `test_list_entities_filters_by_min_confidence`:
     - Create entities with confidence: 0.3, 0.5, 0.7, 0.9
     - GET /api/v1/companies/{id}/entities?minConfidence=0.6
     - Assert len(data) == 2 (only 0.7 and 0.9)

   - `test_list_entities_combined_filters`:
     - Create mixed entities with various types and confidences
     - GET /api/v1/companies/{id}/entities?type=person&minConfidence=0.5
     - Assert only high-confidence person entities returned

2. **Test class: TestEntitiesPagination**

   - `test_list_entities_default_pagination`:
     - Create 60 entities
     - GET /api/v1/companies/{id}/entities
     - Assert len(data) == 50 (default pageSize)
     - Assert meta.total == 60
     - Assert meta.page == 1
     - Assert meta.totalPages == 2

   - `test_list_entities_custom_page_size`:
     - Create 30 entities
     - GET /api/v1/companies/{id}/entities?pageSize=10
     - Assert len(data) == 10
     - Assert meta.totalPages == 3

   - `test_list_entities_page_navigation`:
     - Create 25 entities
     - GET page 1 with pageSize=10
     - Assert len(data) == 10
     - GET page 2 with pageSize=10
     - Assert len(data) == 10
     - GET page 3 with pageSize=10
     - Assert len(data) == 5

   - `test_list_entities_page_size_capped_at_100`:
     - Create 150 entities
     - GET /api/v1/companies/{id}/entities?pageSize=200
     - Assert len(data) <= 100 (max page size)

3. **Test class: TestEntitiesErrorHandling**

   - `test_list_entities_company_not_found`:
     - GET /api/v1/companies/nonexistent-uuid/entities
     - Assert 404 response
     - Assert error.code == 'NOT_FOUND'

   - `test_list_entities_invalid_type_ignored`:
     - Create entities
     - GET /api/v1/companies/{id}/entities?type=invalid_type
     - Assert 200 response (invalid type silently ignored)
     - Assert returns all entities (no filter applied)

   - `test_list_entities_invalid_page_number_clamped`:
     - Create entities
     - GET /api/v1/companies/{id}/entities?page=0
     - Assert 200 response
     - Assert meta.page == 1 (clamped to minimum)

4. **Test class: TestEntityResponseFormat**

   - `test_entity_response_includes_context_snippet`:
     - Create entity with context_snippet
     - GET entities
     - Assert entity has contextSnippet field
     - Assert contextSnippet matches saved value

   - `test_entity_response_includes_source_url`:
     - Create entity with source_url
     - GET entities
     - Assert entity has sourceUrl field
     - Assert sourceUrl matches saved value

   - `test_entity_types_serialized_correctly`:
     - Create entities with each EntityType (person, org, location, email, phone, etc.)
     - GET entities
     - Assert entityType values are lowercase strings

5. Use `app` fixture and `client` fixture from conftest.py for Flask test client.

6. Each test should create its own test data and be independent.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_entities_api_integration.py -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>All API integration tests pass, verifying API-10 requirement is met with filtering, pagination, and proper response format.</done>
</task>

</tasks>

<verification>
Run API integration tests to verify endpoint behavior:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_entities_api_integration.py -v
```

Expected: All tests pass, demonstrating API-10 requirement is satisfied.
</verification>

<success_criteria>
- [ ] Tests cover GET /companies/:id/entities endpoint
- [ ] Type filtering works correctly
- [ ] Confidence filtering works correctly
- [ ] Pagination returns correct totals and page counts
- [ ] Response format matches EntityItem schema
- [ ] Error cases handled properly (404, invalid params)
</success_criteria>

<output>
After completion, create `.planning/phases/02-entity-extraction/02-02-SUMMARY.md`
</output>
