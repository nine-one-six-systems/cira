---
phase: 06-batch-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_batch_integration.py
  - backend/tests/fixtures/batch_fixtures.py
autonomous: true

must_haves:
  truths:
    - "Batch pipeline processes CSV upload through to queued companies"
    - "Validation errors are reported per row with specific messages"
    - "Template download provides correct CSV structure"
    - "Companies from batch are correctly associated with BatchJob"
    - "Batch progress tracks company status changes"
  artifacts:
    - path: "backend/tests/test_batch_integration.py"
      provides: "Integration tests for full batch pipeline flow"
      min_lines: 180
    - path: "backend/tests/fixtures/batch_fixtures.py"
      provides: "Shared fixtures for batch testing"
      min_lines: 60
  key_links:
    - from: "CSV upload"
      to: "Company creation"
      via: "batch.py process_csv_row"
      pattern: "process_csv_row"
    - from: "BatchJob"
      to: "Company"
      via: "batch_id foreign key"
      pattern: "batch_id=batch.id"
    - from: "Company status change"
      to: "BatchJob counts"
      via: "on_company_status_change"
      pattern: "on_company_status_change"
---

<objective>
Create integration tests for the batch processing pipeline that verify complete data flow from CSV upload through company creation and batch queue management.

Purpose: Validate that existing batch implementation correctly processes CSV files, creates companies, and manages batch queue state, catching any wiring issues between components.

Output: Integration test file with fixtures exercising full batch pipeline flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-batch-processing/06-RESEARCH.md
@backend/app/api/routes/batch.py
@backend/app/services/batch_queue_service.py
@backend/app/models/batch.py
@backend/tests/test_batch_api.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch integration test fixtures</name>
  <files>backend/tests/fixtures/batch_fixtures.py</files>
  <action>
Create shared fixtures for batch integration testing at `backend/tests/fixtures/batch_fixtures.py`:

1. If `backend/tests/fixtures/__init__.py` doesn't exist, create it (empty file)

2. Create `backend/tests/fixtures/batch_fixtures.py` with:

   - `VALID_CSV_CONTENT`: String containing valid 5-row CSV:
     ```
     company_name,website_url,industry
     Acme Corp,https://acme.com,Technology
     Beta Inc,https://beta.io,Healthcare
     Gamma Ltd,https://gamma.co,Finance
     Delta LLC,https://delta.org,Manufacturing
     Epsilon Co,https://epsilon.net,Retail
     ```

   - `MIXED_VALIDITY_CSV`: String with 3 valid, 2 invalid rows:
     ```
     company_name,website_url,industry
     Valid One,https://valid1.com,Tech
     ,https://noname.com,Tech
     Valid Two,https://valid2.com,Finance
     Invalid URL,not-a-url,Tech
     Valid Three,https://valid3.com,Healthcare
     ```

   - `CSV_WITH_DUPLICATES`: String with duplicate URLs:
     ```
     company_name,website_url,industry
     First,https://same.com,Tech
     Second,https://same.com,Finance
     Third,https://unique.com,Healthcare
     ```

   - `LARGE_CSV_CONTENT`: Function that generates 50-row CSV for load testing

   - `create_csv_file(content: str, filename: str = 'test.csv')`: Helper function returning tuple `(BytesIO, filename)` for upload

   - `create_batch_with_companies(db, company_count: int, batch_status: BatchStatus = BatchStatus.PENDING)`: Factory function that:
     - Creates BatchJob with specified status
     - Creates N Company records associated with batch
     - Returns tuple (batch, companies)

   - `create_processing_batch(db)`: Factory function that:
     - Creates BatchJob with PROCESSING status
     - Creates 2 PENDING, 1 IN_PROGRESS, 1 COMPLETED companies
     - Returns tuple (batch, companies)

Include docstrings mapping to requirements (BAT-01 through BAT-04, API-02).
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -c "from backend.tests.fixtures.batch_fixtures import VALID_CSV_CONTENT, create_batch_with_companies, MIXED_VALIDITY_CSV; print(f'Valid CSV rows: {len(VALID_CSV_CONTENT.strip().split(chr(10)))-1}')"
```
  </verify>
  <done>Fixture module exists with CSV content samples and factory functions for batch testing.</done>
</task>

<task type="auto">
  <name>Task 2: Create batch pipeline integration tests</name>
  <files>backend/tests/test_batch_integration.py</files>
  <action>
Create integration tests verifying the full batch pipeline in `backend/tests/test_batch_integration.py`:

1. **Test class: TestBatchUploadFlow (BAT-01, BAT-02, API-02)**

   - `test_valid_csv_creates_all_companies` (BAT-01, API-02):
     - Upload VALID_CSV_CONTENT via POST /companies/batch
     - Assert 201 response with success=True
     - Assert all 5 companies created in database
     - Assert each company has correct name and URL
     - Assert companies have PENDING status

   - `test_mixed_csv_reports_per_row_errors` (BAT-02):
     - Upload MIXED_VALIDITY_CSV
     - Assert response has totalCount=5, successful=3, failed=2
     - Assert specific error messages for each failed row
     - Assert row 2 error mentions "name required"
     - Assert row 4 error mentions "Invalid URL"

   - `test_duplicate_urls_detected` (BAT-02):
     - Upload CSV_WITH_DUPLICATES
     - Assert second occurrence of same.com has error
     - Assert first occurrence succeeds

   - `test_companies_linked_to_batch_job`:
     - Upload valid CSV
     - Assert all created companies have batch_id set
     - Query BatchJob and verify it exists
     - Verify batch.total_companies matches upload count

2. **Test class: TestBatchQueueFlow (BAT-04)**

   - `test_batch_start_schedules_companies`:
     - Create batch with pending companies using fixture
     - Call POST /batches/{id}/start
     - Assert batch status changes to PROCESSING
     - Assert at least one company scheduled (IN_PROGRESS)

   - `test_company_completion_updates_batch_counts`:
     - Create processing batch with companies
     - Simulate company completion (status change)
     - Call batch_queue_service.on_company_status_change()
     - Assert batch.completed_companies incremented

   - `test_batch_auto_completes_when_all_done`:
     - Create batch where all companies are COMPLETED
     - Trigger status update for last company
     - Assert batch status becomes COMPLETED

3. **Test class: TestTemplateDownload (BAT-03)**

   - `test_template_has_required_columns`:
     - GET /companies/template
     - Assert response contains company_name, website_url, industry
     - Assert Content-Type is text/csv

   - `test_template_includes_example_data`:
     - GET /companies/template
     - Parse CSV content
     - Assert at least 2 rows (header + example)

4. **Test class: TestBatchProgressTracking**

   - `test_progress_percentage_calculation`:
     - Create batch with 10 companies, 5 completed
     - GET /batches/{id}/progress
     - Assert progress_percentage is 50

   - `test_progress_includes_all_counts`:
     - Create processing batch with mixed statuses
     - GET /batches/{id}/progress
     - Assert pending, processing, completed, failed counts correct

5. Use `@pytest.fixture` for app context and database setup.

6. Each test should have docstring with requirement ID (BAT-XX, API-XX) traceability.

7. Import fixtures from `backend.tests.fixtures.batch_fixtures`.

8. Mock job_service.start_job to avoid actual Celery task dispatch.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py -v --tb=short 2>&1 | head -60
```
  </verify>
  <done>All integration tests pass, verifying BAT-01 through BAT-04 and API-02 requirements for batch pipeline flow.</done>
</task>

</tasks>

<verification>
Run all batch integration tests to verify complete pipeline flow:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_batch_integration.py -v
```

Expected: All tests pass, demonstrating batch pipeline correctly handles CSV uploads through queue management.
</verification>

<success_criteria>
- [ ] Fixture module provides CSV samples and factory functions
- [ ] Integration tests cover batch upload flow (BAT-01, BAT-02, API-02)
- [ ] Tests verify template download (BAT-03)
- [ ] Tests verify batch queue management (BAT-04)
- [ ] Tests verify progress tracking
- [ ] All tests pass with existing implementation
- [ ] Tests documented with requirement traceability in docstrings
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-processing/06-01-SUMMARY.md`
</output>
