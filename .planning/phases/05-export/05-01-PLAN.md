---
phase: 05-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_export_integration.py
  - backend/tests/fixtures/export_fixtures.py
autonomous: true

must_haves:
  truths:
    - "Export pipeline generates valid files from complete analysis data"
    - "All four formats (MD, DOCX, PDF, JSON) produce correct output"
    - "Export content includes all required sections from 2-page template"
    - "Token usage and cost data appear in exports"
    - "Key executives table renders correctly in all formats"
    - "Source URLs are included in export output"
  artifacts:
    - path: "backend/tests/test_export_integration.py"
      provides: "Integration tests for full export pipeline flow"
      min_lines: 200
    - path: "backend/tests/fixtures/export_fixtures.py"
      provides: "Shared fixtures for export testing"
      min_lines: 80
  key_links:
    - from: "ExportService"
      to: "Company model"
      via: "constructor with company data"
      pattern: "ExportService\\(company"
    - from: "generate_export()"
      to: "ExportService methods"
      via: "format dispatch"
      pattern: "generate_(markdown|word|pdf|json)"
    - from: "Export output"
      to: "Analysis.full_analysis"
      via: "section extraction"
      pattern: "_get_analysis_sections"
---

<objective>
Create integration tests for the export pipeline that verify complete data flow from company/analysis models through to formatted export output.

Purpose: Validate that existing ExportService correctly transforms analysis data into all four export formats, catching any wiring issues between the service and data models that unit tests might miss.

Output: Integration test file with fixtures exercising full export generation pipeline.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-export/05-RESEARCH.md
@backend/app/services/export_service.py
@backend/app/api/routes/export.py
@backend/app/models/company.py
@backend/tests/test_export_service.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export integration test fixtures</name>
  <files>backend/tests/fixtures/export_fixtures.py</files>
  <action>
Create shared fixtures for export integration testing at `backend/tests/fixtures/export_fixtures.py`:

1. If `backend/tests/fixtures/__init__.py` doesn't exist, create it (empty file)

2. Create `backend/tests/fixtures/export_fixtures.py` with:

   - `COMPLETE_ANALYSIS_DATA`: Dict containing full analysis sections matching the 2-page template structure:
     - `companyOverview`: content, sources, confidence
     - `businessModel`: content with product list, sources, confidence
     - `teamLeadership`: content mentioning key executives, sources, confidence
     - `marketPosition`: content, sources, confidence
     - `technology`: content with tech stack details, sources, confidence
     - `keyInsights`: bullet point content, sources, confidence
     - `redFlags`: content identifying concerns, sources, confidence

   - `EXECUTIVE_SUMMARY_TEXT`: String with sample executive summary (2-3 paragraphs)

   - `KEY_EXECUTIVES`: List of dicts with executive data:
     - 4-5 executives with name, role, source_url
     - Include CEO, CTO, CFO, VP Engineering, Head of Product

   - `TOKEN_USAGE_RECORDS`: List of dicts simulating token usage:
     - 3-4 records with api_call_type, section, input_tokens, output_tokens
     - Total should be realistic (10K-20K tokens)

   - `CRAWLED_PAGES`: List of dicts with page data:
     - 5-8 pages covering about, team, products, careers, contact
     - Include url, page_type, crawled_at, content_length

   - `create_complete_export_company(db)`: Factory function that:
     - Creates Company with status=COMPLETED, realistic metadata
     - Creates Analysis with full_analysis=COMPLETE_ANALYSIS_DATA
     - Creates Entity records for executives from KEY_EXECUTIVES
     - Creates Page records from CRAWLED_PAGES
     - Creates TokenUsage records from TOKEN_USAGE_RECORDS
     - Returns company object with all relationships loaded

   - `create_minimal_export_company(db)`: Factory function that:
     - Creates Company with status=COMPLETED
     - Creates Analysis with executive_summary only (no sections)
     - No entities, no pages, minimal token usage
     - Returns company object (tests graceful handling of sparse data)

Use pytest fixture patterns that can be imported into test files. Include docstrings mapping to requirements (EXP-01 through EXP-05).
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -c "from backend.tests.fixtures.export_fixtures import COMPLETE_ANALYSIS_DATA, create_complete_export_company, KEY_EXECUTIVES; print(f'Analysis sections: {len(COMPLETE_ANALYSIS_DATA)}, Executives: {len(KEY_EXECUTIVES)}')"
```
  </verify>
  <done>Fixture module exists with complete analysis data and factory functions for export testing.</done>
</task>

<task type="auto">
  <name>Task 2: Create export pipeline integration tests</name>
  <files>backend/tests/test_export_integration.py</files>
  <action>
Create integration tests verifying the full export pipeline in `backend/tests/test_export_integration.py`:

1. **Test class: TestExportDataFlow (EXP-01 through EXP-04)**

   - `test_markdown_includes_all_analysis_sections` (EXP-01, EXP-05):
     - Create complete export company with all analysis sections
     - Generate markdown export
     - Assert all 7 sections present: Company Overview, Business Model, Team, Market, Technology, Insights, Red Flags
     - Assert executive summary appears before sections
     - Assert source URLs appear in Sources section

   - `test_word_includes_all_analysis_sections` (EXP-02, EXP-05):
     - Create complete export company
     - Generate Word export
     - Parse with python-docx
     - Assert all section headings present in paragraphs
     - Assert metadata table has all required fields

   - `test_pdf_includes_all_analysis_sections` (EXP-03, EXP-05):
     - Create complete export company
     - Generate PDF export
     - Parse with PyPDF2
     - Assert key content extractable (company name, executive summary text)
     - Assert page count reasonable (1-3 pages per 2-page template)

   - `test_json_includes_all_structured_data` (EXP-04):
     - Create complete export company
     - Generate JSON export with include_raw_data=True
     - Assert company metadata present
     - Assert analysis sections with confidence scores
     - Assert entities array matches database count
     - Assert pages array matches database count
     - Assert tokenUsage statistics correct

2. **Test class: TestExportExecutiveTable (EXP-05)**

   - `test_markdown_executive_table_format`:
     - Create company with KEY_EXECUTIVES
     - Generate markdown
     - Assert GFM table format: `| Name | Role |` header
     - Assert all executives appear in table

   - `test_word_executive_table`:
     - Create company with KEY_EXECUTIVES
     - Generate Word export
     - Assert table with executive names exists

3. **Test class: TestExportTokenStatistics**

   - `test_markdown_includes_token_usage`:
     - Create company with TOKEN_USAGE_RECORDS
     - Generate markdown
     - Assert token count appears in metadata
     - Assert estimated cost appears

   - `test_json_includes_token_breakdown`:
     - Create company with TOKEN_USAGE_RECORDS
     - Generate JSON
     - Assert tokenUsage.total matches sum
     - Assert tokenUsage.estimatedCost > 0

4. **Test class: TestExportSourceUrls (EXP-05)**

   - `test_markdown_lists_source_pages`:
     - Create company with CRAWLED_PAGES
     - Generate markdown
     - Assert Sources section contains page URLs

   - `test_json_includes_pages`:
     - Create company with CRAWLED_PAGES
     - Generate JSON with include_raw_data=True
     - Assert pages array contains all crawled URLs

5. **Test class: TestExportWithSparseData**

   - `test_markdown_handles_missing_sections`:
     - Create minimal export company (no sections)
     - Generate markdown
     - Assert placeholder text appears for missing sections
     - Assert no errors thrown

   - `test_all_formats_succeed_with_minimal_data`:
     - Create minimal export company
     - Generate all four formats
     - Assert no exceptions raised
     - Assert output non-empty

6. Use `@pytest.fixture` for app context and database setup.

7. Each test should have docstring with requirement ID (EXP-XX) traceability.

8. Import fixtures from `backend.tests.fixtures.export_fixtures`.
  </action>
  <verify>
```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_integration.py -v --tb=short 2>&1 | head -80
```
  </verify>
  <done>All integration tests pass, verifying EXP-01 through EXP-05 requirements for export pipeline data flow.</done>
</task>

</tasks>

<verification>
Run all export integration tests to verify complete data flow:

```bash
cd /Users/stephenhollifield/Cira && python3 -m pytest backend/tests/test_export_integration.py -v
```

Expected: All tests pass, demonstrating export pipeline correctly transforms analysis data into all four formats.
</verification>

<success_criteria>
- [ ] Fixture module provides complete analysis data and factory functions
- [ ] Integration tests cover all four export formats (EXP-01 through EXP-04)
- [ ] Tests verify 2-page template structure (EXP-05)
- [ ] Tests verify executive table, token stats, and source URLs
- [ ] Tests verify graceful handling of sparse data
- [ ] All tests pass with existing implementation
- [ ] Tests documented with requirement traceability in docstrings
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-01-SUMMARY.md`
</output>
